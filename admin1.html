<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prima Academy - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="js/firebase-config.js"></script>
    
    <!-- Firebase Modules -->
    <script src="js/firebase-db.js"></script>
    <script src="js/firebase-storage.js"></script>
    
    <!-- Admin Configuration -->
    <script src="js/admin-config.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar-width: 250px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            margin-left: 10px;
            font-weight: 600;
        }

        .sidebar-menu {
            padding: 15px 0;
        }

        .sidebar-menu ul {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 12px 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .sidebar-menu li:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu li.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }

        .sidebar-menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
        }

        /* Header Styles */
        .header {
            height: var(--header-height);
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left h1 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .search-box {
            position: relative;
            margin-right: 20px;
        }

        .search-box input {
            padding: 8px 15px 8px 35px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
            width: 200px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--primary);
            width: 250px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .notifications {
            margin-right: 20px;
            position: relative;
            cursor: pointer;
        }

        .notifications i {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--warning);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            margin-left: 20px;
            cursor: pointer;
        }

        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .user-profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-profile-dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .user-profile-dropdown-header .user-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .user-profile-dropdown-header .user-email {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .user-profile-dropdown-menu {
            list-style: none;
            padding: 5px 0;
        }

        .user-profile-dropdown-menu li {
            padding: 0;
        }

        .user-profile-dropdown-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s;
        }

        .user-profile-dropdown-menu a:hover {
            background-color: #f8f9fa;
            color: var(--primary);
        }

        .user-profile-dropdown-menu a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .user-profile-dropdown-menu a.logout {
            color: #ef233c;
            border-top: 1px solid #eee;
        }

        .user-profile-dropdown-menu a.logout:hover {
            background-color: rgba(239, 35, 60, 0.1);
            color: #ef233c;
        }

        /* Content Styles */
        .content {
            padding: 30px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .stat-card {
            display: flex;
            align-items: center;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .bg-primary-light {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .bg-success-light {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .bg-warning-light {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }

        .bg-info-light {
            background-color: rgba(72, 149, 239, 0.1);
            color: var(--info);
        }

        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-header h3 {
            font-size: 1.2rem;
        }

        .recent-activities {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        .activity-list {
            margin-top: 15px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
        }

        .activity-info h4 {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .activity-info p {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .activity-time {
            margin-left: auto;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .tables-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            font-weight: 600;
            color: var(--primary);
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .status-pending {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }

        .status-inactive {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn i {
            margin-right: 5px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            outline: none;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* Enrollment Form Styles */
        .enrollment-form-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .form-note {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .upload-area i {
            font-size: 2rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #6c757d;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 0.8rem;
            color: #999;
        }

        .file-requirements {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Class Cards */
        .class-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .class-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: transform 0.3s;
        }

        .class-card:hover {
            transform: translateY(-5px);
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .class-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .class-stats {
            display: flex;
            gap: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .class-instructors {
            margin-top: 15px;
        }

        .instructor-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .instructor-tag {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* Settings Styles */
        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* Search and Filter Styles */
        .search-filter-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .search-input-wrapper i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background-color: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 5px 5px 0 0;
        }

        .filter-badge i {
            cursor: pointer;
            font-size: 0.7rem;
        }

        .active-filters {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-results i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        .results-count {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Date Range Selector Styles */
        .date-range-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .date-range-selector label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .date-range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-range-inputs input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .date-range-presets {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .date-preset-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .date-preset-btn:hover {
            background-color: #f8f9fa;
            border-color: var(--primary);
        }

        .date-preset-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Chart Export Styles */
        .chart-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chart-actions button {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Custom Report Builder Styles */
        .report-builder {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 30px;
        }

        .report-builder-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .report-builder-section:last-child {
            border-bottom: none;
        }

        .report-builder-section h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .chart-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-type-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chart-type-option:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .chart-type-option.selected {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .chart-type-option i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .chart-type-option span {
            display: block;
            font-weight: 600;
            color: var(--dark);
        }

        .metric-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .metric-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .metric-checkbox:hover {
            background-color: #f8f9fa;
        }

        .metric-checkbox input[type="checkbox"] {
            margin-right: 10px;
        }

        .preview-chart-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            min-height: 300px;
        }

        /* User Management Styles */
        .profile-picture-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-picture-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary);
            margin: 0 auto 15px;
            display: block;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-picture-preview:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .profile-picture-upload {
            display: none;
        }

        .upload-picture-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-picture-btn:hover {
            background-color: var(--secondary);
        }

        .password-strength {
            margin-top: 5px;
            font-size: 0.85rem;
        }

        .password-strength-bar {
            height: 4px;
            background-color: #eee;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .password-strength-fill {
            height: 100%;
            transition: all 0.3s;
            border-radius: 2px;
        }

        .password-strength-weak {
            background-color: #ef233c;
            width: 33%;
        }

        .password-strength-medium {
            background-color: #f72585;
            width: 66%;
        }

        .password-strength-strong {
            background-color: #4cc9f0;
            width: 100%;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-admin {
            background-color: rgba(239, 35, 60, 0.1);
            color: #ef233c;
        }

        .role-instructor {
            background-color: rgba(67, 97, 238, 0.1);
            color: #4361ee;
        }

        .role-manager {
            background-color: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .permission-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .permission-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .quick-action-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .quick-action-card i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .quick-action-card h4 {
            color: var(--dark);
            margin-bottom: 5px;
        }

        .quick-action-card p {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .account-settings-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .account-settings-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item label {
            font-weight: 500;
            color: var(--dark);
        }

        .setting-item .setting-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Notifications System Styles */
        .notification-icon {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .notification-icon:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ef233c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 2px solid white;
        }

        .notification-badge.hidden {
            display: none;
        }

        .notification-center {
            position: absolute;
            top: 100%;
            right: 0;
            width: 380px;
            max-height: 500px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            margin-top: 10px;
        }

        .notification-center.active {
            display: flex;
        }

        .notification-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            font-size: 1.1rem;
            color: var(--dark);
            margin: 0;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
        }

        .notification-actions button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .notification-actions button:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        .notification-list {
            overflow-y: auto;
            max-height: 400px;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            gap: 12px;
            position: relative;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: rgba(67, 97, 238, 0.05);
            border-left: 3px solid var(--primary);
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
        }

        .notification-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-icon-wrapper.success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .notification-icon-wrapper.info {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .notification-icon-wrapper.warning {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }

        .notification-icon-wrapper.error {
            background-color: rgba(239, 35, 60, 0.1);
            color: #ef233c;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .notification-message {
            color: #6c757d;
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .notification-time {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }

        .notification-empty i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .notification-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .notification-footer button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px 20px;
            min-width: 300px;
            max-width: 400px;
            z-index: 10000;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: slideInRight 0.3s ease-out;
            margin-bottom: 10px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-toast.success {
            border-left: 4px solid var(--success);
        }

        .notification-toast.info {
            border-left: 4px solid var(--primary);
        }

        .notification-toast.warning {
            border-left: 4px solid var(--warning);
        }

        .notification-toast.error {
            border-left: 4px solid #ef233c;
        }

        .notification-toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notification-toast-icon.success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .notification-toast-icon.info {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        .notification-toast-icon.warning {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }

        .notification-toast-icon.error {
            background-color: rgba(239, 35, 60, 0.1);
            color: #ef233c;
        }

        .notification-toast-content {
            flex: 1;
        }

        .notification-toast-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .notification-toast-message {
            color: #6c757d;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .notification-toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-toast-close:hover {
            color: var(--dark);
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .charts-row, .tables-row, .form-row {
                grid-template-columns: 1fr;
            }
            .filter-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .sidebar-header h2, .sidebar-menu span {
                display: none;
            }
            .sidebar-menu i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            .main-content {
                margin-left: 70px;
            }
            .search-box input {
                width: 150px;
            }
            .search-box input:focus {
                width: 180px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-graduation-cap fa-2x"></i>
            <h2>Prima Academy</h2>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li class="active" data-page="dashboard">
                    <a href="#">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li data-page="students">
                    <a href="#">
                        <i class="fas fa-user-graduate"></i>
                        <span>Students</span>
                    </a>
                </li>
                <li data-page="enrollment">
                    <a href="#">
                        <i class="fas fa-user-plus"></i>
                        <span>Enrollment</span>
                    </a>
                </li>
                <li data-page="classes">
                    <a href="#">
                        <i class="fas fa-chalkboard"></i>
                        <span>Classes</span>
                    </a>
                </li>
                <li data-page="instructors">
                    <a href="#">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Instructors</span>
                    </a>
                </li>
                <li data-page="schedule">
                    <a href="#">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Schedule</span>
                    </a>
                </li>
                <li data-page="payments">
                    <a href="#">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Payments</span>
                    </a>
                </li>
                <li data-page="reports">
                    <a href="#">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li data-page="settings">
                    <a href="#">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1 id="page-title">Admin Dashboard</h1>
            </div>
            <div class="header-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearch" placeholder="Search..." onkeyup="handleGlobalSearch()">
                </div>
                <div class="notification-icon" onclick="toggleNotificationCenter(event)">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge hidden" id="notificationBadge">0</span>
                    <div class="notification-center" id="notificationCenter" onclick="event.stopPropagation()">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <button onclick="markAllAsRead()">Mark all as read</button>
                                <button onclick="clearAllNotifications()">Clear all</button>
                            </div>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <!-- Notifications will be populated by JavaScript -->
                        </div>
                        <div class="notification-footer">
                            <button onclick="viewAllNotifications()">View All Notifications</button>
                        </div>
                    </div>
                </div>
                <div class="user-profile" onclick="toggleUserDropdown()">
                    <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin User" id="userProfileImage">
                    <span id="userProfileName">Admin User</span>
                    <i class="fas fa-chevron-down" style="margin-left: 8px; font-size: 0.8rem;"></i>
                    <div class="user-profile-dropdown" id="userProfileDropdown">
                        <div class="user-profile-dropdown-header">
                            <div class="user-name" id="dropdownUserName">Admin User</div>
                            <div class="user-email" id="dropdownUserEmail">admin@prima.com</div>
                        </div>
                        <ul class="user-profile-dropdown-menu">
                            <li>
                                <a href="#" onclick="event.preventDefault(); viewProfile();">
                                    <i class="fas fa-user"></i>
                                    <span>Edit Profile</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" onclick="event.preventDefault(); openChangePasswordModal();">
                                    <i class="fas fa-key"></i>
                                    <span>Change Password</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" onclick="event.preventDefault(); openSettings();">
                                    <i class="fas fa-cog"></i>
                                    <span>Settings</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="logout" onclick="event.preventDefault(); logout();">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Page -->
            <div class="page active" id="dashboard">
                <div class="page-header">
                    <h2 class="page-title">Dashboard Overview</h2>
                    <div>
                        <button class="btn btn-outline" onclick="exportDashboardReport()"><i class="fas fa-download"></i> Export Report</button>
                    </div>
                </div>

                <!-- Date Range Selector -->
                <div class="date-range-selector">
                    <label>Date Range:</label>
                    <div class="date-range-inputs">
                        <input type="date" id="dashboardStartDate" onchange="updateDashboardCharts()">
                        <span>to</span>
                        <input type="date" id="dashboardEndDate" onchange="updateDashboardCharts()">
                    </div>
                    <div class="date-range-presets">
                        <button class="date-preset-btn" onclick="setDateRange('today')">Today</button>
                        <button class="date-preset-btn" onclick="setDateRange('week')">This Week</button>
                        <button class="date-preset-btn active" onclick="setDateRange('month')">This Month</button>
                        <button class="date-preset-btn" onclick="setDateRange('year')">This Year</button>
                        <button class="date-preset-btn" onclick="setDateRange('all')">All Time</button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-cards">
                    <div class="card stat-card">
                        <div class="stat-icon bg-primary-light">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="stat-info">
                            <h3>1,254</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon bg-success-light">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-info">
                            <h3>48</h3>
                            <p>Instructors</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon bg-warning-light">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                        <div class="stat-info">
                            <h3>12</h3>
                            <p>Classes</p>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon bg-info-light">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3>$24,580</h3>
                            <p>Revenue</p>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-row">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Student Enrollment Trend</h3>
                            <div class="chart-actions">
                                <select id="enrollmentChartType" onchange="updateEnrollmentChart()">
                                    <option value="line">Line Chart</option>
                                    <option value="bar">Bar Chart</option>
                                    <option value="area">Area Chart</option>
                                </select>
                                <button class="btn btn-sm btn-outline" onclick="exportChart('enrollmentChart', 'Student Enrollment Trend')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <canvas id="enrollmentChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Class Distribution</h3>
                            <div class="chart-actions">
                                <select id="classChartType" onchange="updateClassChart()">
                                    <option value="doughnut">Doughnut</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="bar">Bar Chart</option>
                                </select>
                                <button class="btn btn-sm btn-outline" onclick="exportChart('classChart', 'Class Distribution')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <canvas id="classChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activities & Classes Row -->
                <div class="charts-row">
                    <div class="recent-activities">
                        <div class="chart-header">
                            <h3>Recent Activities</h3>
                            <button class="btn btn-outline">View All</button>
                        </div>
                        <div class="activity-list" id="recentActivitiesList">
                            <!-- Activities populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="chart-header">
                            <h3>Recent Enrollments</h3>
                            <button class="btn btn-outline">View All</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Class</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentEnrollmentsTable">
                                <!-- Recent enrollments populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Students Page -->
            <div class="page" id="students">
                <div class="page-header">
                    <h2 class="page-title">Student Management</h2>
                    <div>
                        <button class="btn btn-primary" id="addStudentBtn"><i class="fas fa-plus"></i> Add Student</button>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="search-filter-container">
                    <div class="filter-row">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="studentSearch" placeholder="Search by name, email, or ID..." onkeyup="filterStudents()">
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="studentStatusFilter" class="form-control" onchange="filterStudents()">
                                <!-- Populated dynamically by populateStatusDropdown -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Class</label>
                            <select id="studentClassFilter" class="form-control" onchange="filterStudents()">
                                <!-- Populated dynamically by populateGradeLevelDropdown -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Enrollment Date</label>
                            <input type="date" id="studentDateFilter" class="form-control" onchange="filterStudents()">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-outline" onclick="clearStudentFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    <div class="active-filters" id="studentActiveFilters" style="display: none;">
                        <strong>Active Filters:</strong>
                        <div id="studentFilterBadges"></div>
                    </div>
                    <div class="results-count" id="studentResultsCount"></div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Class</th>
                                <th>Enrollment Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Students will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Enrollment Page -->
            <div class="page" id="enrollment">
                <div class="page-header">
                    <h2 class="page-title">Student Enrollment</h2>
                    <div>
                        <button class="btn btn-outline" onclick="viewEnrollmentApplications()"><i class="fas fa-list"></i> View Applications</button>
                    </div>
                </div>

                <div class="enrollment-form-container">
                    <form id="enrollmentForm">
                        <!-- Student Information Section -->
                        <div class="form-section">
                            <h3 class="section-title">Student Information</h3>
                            <p class="form-note">Please provide the student's personal details</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name *</label>
                                    <input type="text" id="firstName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name *</label>
                                    <input type="text" id="lastName" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="middleName">Middle Name</label>
                                    <input type="text" id="middleName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="dateOfBirth">Date of Birth *</label>
                                    <input type="date" id="dateOfBirth" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gender">Gender *</label>
                                    <select id="gender" class="form-control" required>
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="nationality">Nationality *</label>
                                    <input type="text" id="nationality" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="homeAddress">Home Address *</label>
                                <input type="text" id="homeAddress" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="city">City *</label>
                                    <input type="text" id="city" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="postalCode">Postal Code *</label>
                                    <input type="text" id="postalCode" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="gradeLevel">Applying For Grade Level *</label>
                                <select id="gradeLevel" class="form-control" required>
                                    <option value="">Select Grade Level</option>
                                    <!-- Populated dynamically by populateGradeLevelDropdown -->
                                </select>
                            </div>
                        </div>

                        <!-- Parent/Guardian Information Section -->
                        <div class="form-section">
                            <h3 class="section-title">Parent/Guardian Information</h3>
                            <p class="form-note">Please provide details of the parent or legal guardian</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="parentFirstName">Parent/Guardian First Name *</label>
                                    <input type="text" id="parentFirstName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="parentLastName">Parent/Guardian Last Name *</label>
                                    <input type="text" id="parentLastName" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="relationship">Relationship to Student *</label>
                                    <select id="relationship" class="form-control" required>
                                        <option value="">Select Relationship</option>
                                        <option value="Mother">Mother</option>
                                        <option value="Father">Father</option>
                                        <option value="Guardian">Guardian</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="parentPhone">Phone Number *</label>
                                    <input type="tel" id="parentPhone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="parentEmail">Email Address *</label>
                                    <input type="email" id="parentEmail" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="parentOccupation">Occupation</label>
                                    <input type="text" id="parentOccupation" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="parentAddress">Parent/Guardian Address (if different from student)</label>
                                <input type="text" id="parentAddress" class="form-control">
                            </div>
                            
                            <h4>Emergency Contact (Other than Parent/Guardian)</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emergencyName">Full Name *</label>
                                    <input type="text" id="emergencyName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="emergencyRelationship">Relationship *</label>
                                    <input type="text" id="emergencyRelationship" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emergencyPhone">Phone Number *</label>
                                    <input type="tel" id="emergencyPhone" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="emergencyEmail">Email Address</label>
                                    <input type="email" id="emergencyEmail" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Academic History Section -->
                        <div class="form-section">
                            <h3 class="section-title">Academic History</h3>
                            <p class="form-note">Please provide information about the student's previous schooling</p>
                            
                            <div class="form-group">
                                <label for="previousSchool">Current/Previous School *</label>
                                <input type="text" id="previousSchool" class="form-control" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="schoolAddress">School Address</label>
                                    <input type="text" id="schoolAddress" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="schoolPhone">School Phone</label>
                                    <input type="tel" id="schoolPhone" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gradeCompleted">Grade Recently Completed *</label>
                                    <select id="gradeCompleted" class="form-control" required>
                                        <option value="">Select Grade</option>
                                        <!-- Populated dynamically by populateGradeLevelDropdown -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="yearsAttended">Years Attended *</label>
                                    <input type="text" id="yearsAttended" class="form-control" placeholder="e.g., 2018-2023" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="reasonForLeaving">Reason for Leaving Previous School</label>
                                <textarea id="reasonForLeaving" class="form-control" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Does the student have any special educational needs, allergies, or medical conditions we should be aware of?</label>
                                <p class="form-note">This information will help us provide appropriate support for the student.</p>
                                <textarea id="specialNeeds" class="form-control" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Extracurricular Activities & Interests</label>
                                <p class="form-note">e.g., sports, music, arts, clubs</p>
                                <textarea id="extracurricular" class="form-control" rows="3" placeholder="Please list any activities the student is interested in or has participated in."></textarea>
                            </div>
                        </div>

                        <!-- Required Documents Section -->
                        <div class="form-section">
                            <h3 class="section-title">Required Documents</h3>
                            <p class="form-note">Please upload the following documents to complete your application</p>
                            
                            <div class="form-group">
                                <label>8th Certificate *</label>
                                <div class="upload-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p class="upload-text">Click to upload 8th Certificate</p>
                                    <p class="upload-hint">1st type: PCS, PKI, PKC (blue: 5x8)</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Previous School Report Cards/Transcripts *</label>
                                <div class="upload-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p class="upload-text">Click to upload Report Cards/Transcripts</p>
                                    <p class="upload-hint">1st type: PCS, PKI, PKC (blue: 10x16)</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Immunization Records</label>
                                <div class="upload-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p class="upload-text">Click to upload Immunization Records</p>
                                    <p class="upload-hint">1st type: PCS, PKI, PKC (blue: 5x8)</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Passport sized Photography</label>
                                <div class="upload-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p class="upload-text">Click to upload Student Photography</p>
                                    <p class="upload-hint">1st type: PKI, PKC (blue: 2x6)</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Other Supporting Documents (if any)</label>
                                <div class="upload-area">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p class="upload-text">Click to upload Other Documents</p>
                                    <p class="upload-hint">1st type: PCS, PKI, PKC (blue: 10x16)</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-outline">Previous</button>
                            <button type="submit" class="btn btn-primary">Submit Application</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Classes Page -->
            <div class="page" id="classes">
                <div class="page-header">
                    <h2 class="page-title">Class Management</h2>
                    <div>
                        <button class="btn btn-primary" id="addClassBtn"><i class="fas fa-plus"></i> Add Class</button>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="search-filter-container">
                    <div class="filter-row">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="classSearch" placeholder="Search by class name..." onkeyup="filterClasses()">
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="classStatusFilter" class="form-control" onchange="filterClasses()">
                                <!-- Populated dynamically by populateStatusDropdown -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Capacity</label>
                            <select id="classCapacityFilter" class="form-control" onchange="filterClasses()">
                                <option value="">All</option>
                                <option value="full">Full</option>
                                <option value="available">Available</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-outline" onclick="clearClassFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    <div class="active-filters" id="classActiveFilters" style="display: none;">
                        <strong>Active Filters:</strong>
                        <div id="classFilterBadges"></div>
                    </div>
                    <div class="results-count" id="classResultsCount"></div>
                </div>

                <div class="class-cards">
                    <!-- Class cards will be populated by JavaScript -->
                </div>

                <div class="table-container">
                    <div class="chart-header">
                        <h3>Class Details</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Students</th>
                                <th>Instructors</th>
                                <th>Capacity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="classesTableBody">
                            <!-- Classes will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Instructors Page -->
            <div class="page" id="instructors">
                <div class="page-header">
                    <h2 class="page-title">Instructor Management</h2>
                    <div>
                        <button class="btn btn-primary" id="addInstructorBtn"><i class="fas fa-plus"></i> Add Instructor</button>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="search-filter-container">
                    <div class="filter-row">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="instructorSearch" placeholder="Search by name, email, or specialization..." onkeyup="filterInstructors()">
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="instructorStatusFilter" class="form-control" onchange="filterInstructors()">
                                <!-- Populated dynamically by populateStatusDropdown -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Specialization</label>
                            <input type="text" id="instructorSpecializationFilter" class="form-control" placeholder="Filter by specialization..." onkeyup="filterInstructors()">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-outline" onclick="clearInstructorFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    <div class="active-filters" id="instructorActiveFilters" style="display: none;">
                        <strong>Active Filters:</strong>
                        <div id="instructorFilterBadges"></div>
                    </div>
                    <div class="results-count" id="instructorResultsCount"></div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Specialization</th>
                                <th>Classes</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="instructorsTableBody">
                            <!-- Instructors will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Schedule Page -->
            <div class="page" id="schedule">
                <div class="page-header">
                    <h2 class="page-title">Class Schedule</h2>
                    <div>
                        <button class="btn btn-primary" id="addScheduleBtn"><i class="fas fa-plus"></i> Add Schedule</button>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="search-filter-container">
                    <div class="filter-row">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="scheduleSearch" placeholder="Search by class or instructor..." onkeyup="filterSchedule()">
                        </div>
                        <div class="filter-group">
                            <label>Day</label>
                            <select id="scheduleDayFilter" class="form-control" onchange="filterSchedule()">
                                <!-- Populated dynamically by populateDaysDropdown -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Class</label>
                            <select id="scheduleClassFilter" class="form-control" onchange="filterSchedule()">
                                <!-- Populated dynamically by populateGradeLevelDropdown -->
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-outline" onclick="clearScheduleFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    <div class="active-filters" id="scheduleActiveFilters" style="display: none;">
                        <strong>Active Filters:</strong>
                        <div id="scheduleFilterBadges"></div>
                    </div>
                    <div class="results-count" id="scheduleResultsCount"></div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Class</th>
                                <th>Instructor</th>
                                <th>Day</th>
                                <th>Time</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Schedule will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Page -->
            <div class="page" id="payments">
                <div class="page-header">
                    <h2 class="page-title">Payment Management</h2>
                    <div>
                        <button class="btn btn-primary" id="addPaymentBtn"><i class="fas fa-plus"></i> Add Payment</button>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="search-filter-container">
                    <div class="filter-row">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="paymentSearch" placeholder="Search by student name..." onkeyup="filterPayments()">
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="paymentStatusFilter" class="form-control" onchange="filterPayments()">
                                <!-- Populated dynamically by populateStatusDropdown -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Class</label>
                            <select id="paymentClassFilter" class="form-control" onchange="filterPayments()">
                                <!-- Populated dynamically by populateGradeLevelDropdown -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <input type="date" id="paymentDateFilter" class="form-control" onchange="filterPayments()">
                        </div>
                        <div class="filter-group">
                            <label>Amount Range</label>
                            <select id="paymentAmountFilter" class="form-control" onchange="filterPayments()">
                                <option value="">All Amounts</option>
                                <option value="0-1000">$0 - $1,000</option>
                                <option value="1000-1500">$1,000 - $1,500</option>
                                <option value="1500+">$1,500+</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-outline" onclick="clearPaymentFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                    <div class="active-filters" id="paymentActiveFilters" style="display: none;">
                        <strong>Active Filters:</strong>
                        <div id="paymentFilterBadges"></div>
                    </div>
                    <div class="results-count" id="paymentResultsCount"></div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Student</th>
                                <th>Class</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                            <!-- Payments will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Page -->
            <div class="page" id="reports">
                <div class="page-header">
                    <h2 class="page-title">Reports & Analytics</h2>
                    <div>
                        <button class="btn btn-primary" onclick="openCustomReportBuilder()"><i class="fas fa-plus"></i> Create Custom Report</button>
                        <button class="btn btn-outline" onclick="exportAllReports()"><i class="fas fa-download"></i> Export All</button>
                    </div>
                </div>

                <!-- Custom Report Builder -->
                <div class="report-builder" id="customReportBuilder" style="display: none;">
                    <div class="report-builder-section">
                        <h4>1. Select Chart Type</h4>
                        <div class="chart-type-selector">
                            <div class="chart-type-option" onclick="selectChartType('line')">
                                <i class="fas fa-chart-line"></i>
                                <span>Line Chart</span>
                            </div>
                            <div class="chart-type-option" onclick="selectChartType('bar')">
                                <i class="fas fa-chart-bar"></i>
                                <span>Bar Chart</span>
                            </div>
                            <div class="chart-type-option" onclick="selectChartType('pie')">
                                <i class="fas fa-chart-pie"></i>
                                <span>Pie Chart</span>
                            </div>
                            <div class="chart-type-option" onclick="selectChartType('doughnut')">
                                <i class="fas fa-chart-pie"></i>
                                <span>Doughnut</span>
                            </div>
                            <div class="chart-type-option" onclick="selectChartType('area')">
                                <i class="fas fa-chart-area"></i>
                                <span>Area Chart</span>
                            </div>
                        </div>
                    </div>
                    <div class="report-builder-section">
                        <h4>2. Select Metrics</h4>
                        <div class="metric-selector">
                            <label class="metric-checkbox">
                                <input type="checkbox" value="students" onchange="updateReportPreview()">
                                <span>Student Enrollment</span>
                            </label>
                            <label class="metric-checkbox">
                                <input type="checkbox" value="payments" onchange="updateReportPreview()">
                                <span>Payments</span>
                            </label>
                            <label class="metric-checkbox">
                                <input type="checkbox" value="classes" onchange="updateReportPreview()">
                                <span>Class Distribution</span>
                            </label>
                            <label class="metric-checkbox">
                                <input type="checkbox" value="instructors" onchange="updateReportPreview()">
                                <span>Instructors</span>
                            </label>
                            <label class="metric-checkbox">
                                <input type="checkbox" value="revenue" onchange="updateReportPreview()">
                                <span>Revenue</span>
                            </label>
                        </div>
                    </div>
                    <div class="report-builder-section">
                        <h4>3. Date Range</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" id="reportStartDate" class="form-control" onchange="updateReportPreview()">
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" id="reportEndDate" class="form-control" onchange="updateReportPreview()">
                            </div>
                        </div>
                    </div>
                    <div class="report-builder-section">
                        <h4>4. Report Preview</h4>
                        <div class="preview-chart-container">
                            <canvas id="customReportChart"></canvas>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-outline" onclick="closeCustomReportBuilder()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveCustomReport()">Save Report</button>
                        <button class="btn btn-success" onclick="exportCustomReport()">Export Report</button>
                    </div>
                </div>

                <!-- Date Range Selector for Reports -->
                <div class="date-range-selector">
                    <label>Report Period:</label>
                    <div class="date-range-inputs">
                        <input type="date" id="reportsStartDate" onchange="updateReportsCharts()">
                        <span>to</span>
                        <input type="date" id="reportsEndDate" onchange="updateReportsCharts()">
                    </div>
                    <div class="date-range-presets">
                        <button class="date-preset-btn" onclick="setReportsDateRange('today')">Today</button>
                        <button class="date-preset-btn" onclick="setReportsDateRange('week')">This Week</button>
                        <button class="date-preset-btn active" onclick="setReportsDateRange('month')">This Month</button>
                        <button class="date-preset-btn" onclick="setReportsDateRange('year')">This Year</button>
                        <button class="date-preset-btn" onclick="setReportsDateRange('all')">All Time</button>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Revenue Overview</h3>
                            <div class="chart-actions">
                                <select id="revenueChartType" onchange="updateRevenueChart()">
                                    <option value="bar">Bar Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="area">Area Chart</option>
                                </select>
                                <button class="btn btn-sm btn-outline" onclick="exportChart('revenueChart', 'Revenue Overview')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Student Progress</h3>
                            <div class="chart-actions">
                                <select id="progressChartType" onchange="updateProgressChart()">
                                    <option value="pie">Pie Chart</option>
                                    <option value="doughnut">Doughnut</option>
                                    <option value="bar">Bar Chart</option>
                                </select>
                                <button class="btn btn-sm btn-outline" onclick="exportChart('progressChart', 'Student Progress')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <!-- Additional Analytics Charts -->
                <div class="charts-row" style="margin-top: 20px;">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Payment Status Distribution</h3>
                            <div class="chart-actions">
                                <button class="btn btn-sm btn-outline" onclick="exportChart('paymentStatusChart', 'Payment Status')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <canvas id="paymentStatusChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Enrollment by Class</h3>
                            <div class="chart-actions">
                                <button class="btn btn-sm btn-outline" onclick="exportChart('enrollmentByClassChart', 'Enrollment by Class')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <canvas id="enrollmentByClassChart"></canvas>
                    </div>
                </div>

                <div class="table-container">
                    <div class="chart-header">
                        <h3>Performance Metrics</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Current</th>
                                <th>Previous</th>
                                <th>Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Student Enrollment</td>
                                <td>1,254</td>
                                <td>1,120</td>
                                <td><span style="color: green;">+12%</span></td>
                            </tr>
                            <tr>
                                <td>Course Completion</td>
                                <td>78%</td>
                                <td>72%</td>
                                <td><span style="color: green;">+6%</span></td>
                            </tr>
                            <tr>
                                <td>Revenue</td>
                                <td>$24,580</td>
                                <td>$21,450</td>
                                <td><span style="color: green;">+14.6%</span></td>
                            </tr>
                            <tr>
                                <td>Student Satisfaction</td>
                                <td>4.7/5</td>
                                <td>4.5/5</td>
                                <td><span style="color: green;">+4.4%</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page" id="settings">
                <div class="page-header">
                    <h2 class="page-title">System Settings</h2>
                    <div>
                        <button class="btn btn-primary" onclick="viewProfile()"><i class="fas fa-user"></i> Edit Profile</button>
                        <button class="btn btn-outline" onclick="openChangePasswordModal()"><i class="fas fa-key"></i> Change Password</button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="account-settings-section">
                    <h3>Quick Actions</h3>
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" onclick="viewProfile()">
                            <i class="fas fa-user-edit"></i>
                            <h4>Edit Profile</h4>
                            <p>Update your personal information</p>
                        </div>
                        <div class="quick-action-card" onclick="openChangePasswordModal()">
                            <i class="fas fa-key"></i>
                            <h4>Change Password</h4>
                            <p>Update your account password</p>
                        </div>
                        <div class="quick-action-card" onclick="document.getElementById('profilePictureUpload').click()">
                            <i class="fas fa-camera"></i>
                            <h4>Upload Photo</h4>
                            <p>Change your profile picture</p>
                        </div>
                        <div class="quick-action-card" onclick="exportDashboardReport()">
                            <i class="fas fa-download"></i>
                            <h4>Export Data</h4>
                            <p>Download your data</p>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="account-settings-section">
                    <h3>Account Settings</h3>
                    <div class="setting-item">
                        <div>
                            <label>Email Notifications</label>
                            <div class="setting-description">Receive email updates about your account</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="emailNotifications" checked onchange="saveAccountSetting('emailNotifications', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div>
                            <label>SMS Notifications</label>
                            <div class="setting-description">Receive SMS alerts for important updates</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="smsNotifications" onchange="saveAccountSetting('smsNotifications', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div>
                            <label>Two-Factor Authentication</label>
                            <div class="setting-description">Add an extra layer of security to your account</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="twoFactorAuth" onchange="saveAccountSetting('twoFactorAuth', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div>
                            <label>Dark Mode</label>
                            <div class="setting-description">Switch to dark theme</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkMode" onchange="toggleDarkMode(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div>
                            <label>Auto-save</label>
                            <div class="setting-description">Automatically save your work</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoSave" checked onchange="saveAccountSetting('autoSave', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- User Roles & Permissions -->
                <div class="account-settings-section">
                    <h3>User Roles & Permissions</h3>
                    <div class="form-group">
                        <label>Your Current Role</label>
                        <div style="margin-top: 10px;">
                            <span id="currentRoleBadge" class="role-badge role-admin">Administrator</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Your Permissions</label>
                        <div class="permissions-grid" id="userPermissionsGrid">
                            <!-- Permissions will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- General Settings -->
                <div class="settings-section">
                    <h3>General Settings</h3>
                    <div class="card">
                        <div class="form-group">
                            <label for="academyName">Academy Name</label>
                            <input type="text" id="academyName" class="form-control" value="Prima Academy">
                        </div>
                        <div class="form-group">
                            <label for="academyEmail">Contact Email</label>
                            <input type="email" id="academyEmail" class="form-control" value="contact@primaacademy.com">
                        </div>
                        <div class="form-group">
                            <label for="academyPhone">Contact Phone</label>
                            <input type="text" id="academyPhone" class="form-control" value="+1 (555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="academyAddress">Address</label>
                            <textarea id="academyAddress" class="form-control" rows="3">123 Education Street, Knowledge City, KC 12345</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveGeneralSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- User Management -->
                <div class="settings-section">
                    <h3>User Management</h3>
                    <div class="card">
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-primary" onclick="addNewUser()"><i class="fas fa-plus"></i> Add New User</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Last Login</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersManagementTable">
                                    <!-- Users will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for CRUD Operations -->
    
    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="close-modal" onclick="closeModal('editProfileModal')">&times;</button>
            </div>
            <form id="editProfileForm">
                <div class="profile-picture-container">
                    <img id="profilePicturePreview" src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile Picture" class="profile-picture-preview" onclick="document.getElementById('profilePictureUpload').click()">
                    <input type="file" id="profilePictureUpload" class="profile-picture-upload" accept="image/*" onchange="handleProfilePictureUpload(event)">
                    <button type="button" class="upload-picture-btn" onclick="document.getElementById('profilePictureUpload').click()">
                        <i class="fas fa-camera"></i> Change Picture
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="editProfileName">Full Name *</label>
                    <input type="text" id="editProfileName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editProfileEmail">Email Address *</label>
                    <input type="email" id="editProfileEmail" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editProfilePhone">Phone Number</label>
                    <input type="tel" id="editProfilePhone" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="editProfileRole">Role</label>
                    <select id="editProfileRole" class="form-control">
                        <option value="admin">Administrator</option>
                        <option value="instructor">Instructor</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editProfileBio">Bio</label>
                    <textarea id="editProfileBio" class="form-control" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('editProfileModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Change Password</h3>
                <button class="close-modal" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password *</label>
                    <input type="password" id="currentPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password *</label>
                    <input type="password" id="newPassword" class="form-control" required onkeyup="checkPasswordStrength()">
                    <div class="password-strength" id="passwordStrengthText"></div>
                    <div class="password-strength-bar">
                        <div class="password-strength-fill" id="passwordStrengthBar"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password *</label>
                    <input type="password" id="confirmPassword" class="form-control" required onkeyup="checkPasswordMatch()">
                    <div class="password-strength" id="passwordMatchText"></div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('changePasswordModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Student Modal -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="studentModalTitle">Add Student</h3>
                <button class="close-modal" onclick="closeModal('studentModal')">&times;</button>
            </div>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-group">
                    <label for="studentFirstName">First Name *</label>
                    <input type="text" id="studentFirstName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="studentLastName">Last Name *</label>
                    <input type="text" id="studentLastName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="studentEmail">Email *</label>
                    <input type="email" id="studentEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="studentClass">Class *</label>
                    <select id="studentClass" class="form-control" required>
                        <option value="">Select Class</option>
                        <!-- Populated dynamically by populateGradeLevelDropdown -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="studentEnrollmentDate">Enrollment Date *</label>
                    <input type="date" id="studentEnrollmentDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="studentStatus">Status *</label>
                    <select id="studentStatus" class="form-control" required>
                        <!-- Populated dynamically by populateStatusDropdown -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('studentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Class Modal -->
    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="classModalTitle">Add Class</h3>
                <button class="close-modal" onclick="closeModal('classModal')">&times;</button>
            </div>
            <form id="classForm">
                <input type="hidden" id="classId">
                <div class="form-group">
                    <label for="className">Class Name *</label>
                    <select id="className" class="form-control" required onchange="updateClassSubjects()">
                        <option value="">Select Class</option>
                        <!-- Populated dynamically by populateGradeLevelDropdown -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="classSubjects">Subjects (GES Curriculum) *</label>
                    <div id="classSubjectsContainer">
                        <p class="form-text" style="color: #6c757d; font-size: 0.9rem;">Select a class to view available subjects</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="classCapacity">Capacity *</label>
                    <input type="number" id="classCapacity" class="form-control" required min="1">
                </div>
                <div class="form-group">
                    <label for="classInstructors">Instructors (comma-separated)</label>
                    <input type="text" id="classInstructors" class="form-control" placeholder="e.g., Ms. Sarah Wilson, Mr. John Doe">
                </div>
                <div class="form-group">
                    <label for="classStatus">Status *</label>
                    <select id="classStatus" class="form-control" required>
                        <!-- Populated dynamically by populateStatusDropdown -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('classModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Instructor Modal -->
    <div class="modal" id="instructorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="instructorModalTitle">Add Instructor</h3>
                <button class="close-modal" onclick="closeModal('instructorModal')">&times;</button>
            </div>
            <form id="instructorForm">
                <input type="hidden" id="instructorId">
                <div class="form-group">
                    <label for="instructorFirstName">First Name *</label>
                    <input type="text" id="instructorFirstName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="instructorLastName">Last Name *</label>
                    <input type="text" id="instructorLastName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="instructorEmail">Email *</label>
                    <input type="email" id="instructorEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="instructorSpecialization">Specialization *</label>
                    <input type="text" id="instructorSpecialization" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="instructorClasses">Classes (comma-separated)</label>
                    <input type="text" id="instructorClasses" class="form-control" placeholder="e.g., Grade 4, Grade 5">
                </div>
                <div class="form-group">
                    <label for="instructorStatus">Status *</label>
                    <select id="instructorStatus" class="form-control" required>
                        <!-- Populated dynamically by populateStatusDropdown -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('instructorModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="scheduleModalTitle">Add Schedule</h3>
                <button class="close-modal" onclick="closeModal('scheduleModal')">&times;</button>
            </div>
            <form id="scheduleForm">
                <input type="hidden" id="scheduleId">
                <div class="form-group">
                    <label for="scheduleClass">Class *</label>
                    <select id="scheduleClass" class="form-control" required>
                        <option value="">Select Class</option>
                        <!-- Populated dynamically by populateGradeLevelDropdown -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="scheduleInstructor">Instructor *</label>
                    <input type="text" id="scheduleInstructor" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="scheduleDay">Day *</label>
                    <select id="scheduleDay" class="form-control" required>
                        <option value="">Select Day</option>
                        <!-- Populated dynamically by populateDaysDropdown -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="scheduleTime">Time *</label>
                    <input type="time" id="scheduleTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="scheduleDuration">Duration *</label>
                    <input type="text" id="scheduleDuration" class="form-control" required placeholder="e.g., 3 hours">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('scheduleModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="paymentModalTitle">Add Payment</h3>
                <button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                <div class="form-group">
                    <label for="paymentStudent">Student *</label>
                    <input type="text" id="paymentStudent" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="paymentClass">Class *</label>
                    <select id="paymentClass" class="form-control" required>
                        <option value="">Select Class</option>
                        <!-- Populated dynamically by populateGradeLevelDropdown -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentAmount">Amount ($) *</label>
                    <input type="number" id="paymentAmount" class="form-control" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="paymentDate">Date *</label>
                    <input type="date" id="paymentDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="paymentStatus">Status *</label>
                    <select id="paymentStatus" class="form-control" required>
                        <!-- Populated dynamically by populateStatusDropdown -->
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('paymentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION HELPERS ==========
        // Initialize configuration and create helper functions
        function initializeConfig() {
            if (!window.AdminConfig) {
                console.error('AdminConfig not loaded. Please ensure admin-config.js is loaded before admin1.html script.');
                return;
            }
            
            const config = window.AdminConfig;
            
            // Helper function to get messages from config
            window.getConfigMessage = function(type, category = 'success') {
                const config = window.AdminConfig || {};
                return config.messages?.[category]?.[type] || '';
            };
            
            // Helper function to show success/error messages
            window.showConfigMessage = function(action, entity, type = 'success') {
                const config = window.AdminConfig || {};
                const messages = config.messages?.[type] || {};
                const message = messages[action] || `${entity} ${action}`;
                Swal.fire(
                    type === 'success' ? 'Success!' : 'Error',
                    message,
                    type
                );
            };
            
            // Helper function to populate status dropdowns
            window.populateStatusDropdown = function(selectId, statusType = 'default', includeAll = true) {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const statuses = config.status[statusType] || config.status.default || [];
                select.innerHTML = '';
                
                if (includeAll) {
                    const allOption = document.createElement('option');
                    allOption.value = '';
                    allOption.textContent = `All ${statusType === 'default' ? 'Status' : statusType}`;
                    select.appendChild(allOption);
                }
                
                statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    select.appendChild(option);
                });
            };
            
            // Helper function to populate grade level dropdowns
            window.populateGradeLevelDropdown = function(selectId, includeAll = false) {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const grouped = config.gradeLevels.getGrouped();
                select.innerHTML = '';
                
                if (includeAll) {
                    const allOption = document.createElement('option');
                    allOption.value = '';
                    allOption.textContent = 'All Classes';
                    select.appendChild(allOption);
                }
                
                Object.keys(grouped).forEach(groupName => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = groupName;
                    
                    grouped[groupName].forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                });
            };
            
            // Helper function to populate days dropdown
            window.populateDaysDropdown = function(selectId, includeAll = false) {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '';
                
                if (includeAll) {
                    const allOption = document.createElement('option');
                    allOption.value = '';
                    allOption.textContent = 'All Days';
                    select.appendChild(allOption);
                }
                
                config.daysOfWeek.forEach(day => {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    select.appendChild(option);
                });
            };
            
            // Initialize all dropdowns on page load
            document.addEventListener('DOMContentLoaded', function() {
                // Populate status filters
                populateStatusDropdown('studentStatusFilter', 'student', true);
                populateStatusDropdown('classStatusFilter', 'class', true);
                populateStatusDropdown('instructorStatusFilter', 'instructor', true);
                populateStatusDropdown('paymentStatusFilter', 'payment', true);
                
                // Populate grade level filters
                populateGradeLevelDropdown('studentClassFilter', true);
                populateGradeLevelDropdown('scheduleClassFilter', true);
                populateGradeLevelDropdown('paymentClassFilter', true);
                
                // Populate form dropdowns
                populateGradeLevelDropdown('gradeLevel', false);
                populateGradeLevelDropdown('gradeCompleted', false);
                populateGradeLevelDropdown('studentClass', false);
                populateGradeLevelDropdown('scheduleClass', false);
                populateGradeLevelDropdown('paymentClass', false);
                populateGradeLevelDropdown('className', false);
                
                // Populate status form dropdowns
                populateStatusDropdown('studentStatus', 'student', false);
                populateStatusDropdown('classStatus', 'class', false);
                populateStatusDropdown('instructorStatus', 'instructor', false);
                populateStatusDropdown('paymentStatus', 'payment', false);
                
                // Populate days dropdown
                populateDaysDropdown('scheduleDay', false);
                populateDaysDropdown('scheduleDayFilter', true);
            });
        }
        
        // Initialize config when script loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeConfig);
        } else {
            initializeConfig();
        }

        // Data Management with Firestore
        const DataManager = {
            // Initialize Firestore listeners
            async init() {
                if (!window.firebaseDBInstance || !window.firebaseDb) {
                    console.error('Firebase not initialized');
                    return;
                }

                // Set up real-time listeners for all collections
                this.setupRealtimeListeners();
            },

            setupRealtimeListeners() {
                if (!window.firebaseDBInstance) return;

                // Students listener
                window.firebaseDBInstance.onStudentsUpdate((result) => {
                    if (result.success) {
                        students = result.data.map(s => ({
                            ...s,
                            id: s.id, // Keep Firestore ID
                            enrollmentDate: s.enrollmentDate || (s.createdAt?.toDate ? s.createdAt.toDate().toISOString().split('T')[0] : new Date().toISOString().split('T')[0])
                        }));
                        if (typeof filterStudents === 'function') filterStudents();
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    }
                });

                // Classes listener
                window.firebaseDBInstance.onClassesUpdate((result) => {
                    if (result.success) {
                        classes = result.data.map(c => ({
                            ...c,
                            id: c.id,
                            instructors: Array.isArray(c.instructors) ? c.instructors : (c.instructors ? c.instructors.split(',').map(i => i.trim()) : [])
                        }));
                        if (typeof filterClasses === 'function') filterClasses();
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    }
                });

                // Instructors listener
                window.firebaseDBInstance.onInstructorsUpdate((result) => {
                    if (result.success) {
                        instructors = result.data.map(i => ({
                            ...i,
                            id: i.id,
                            classes: Array.isArray(i.classes) ? i.classes : (i.classes ? i.classes.split(',').map(c => c.trim()) : [])
                        }));
                        if (typeof filterInstructors === 'function') filterInstructors();
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    }
                });

                // Schedules listener
                window.firebaseDBInstance.onSchedulesUpdate((result) => {
                    if (result.success) {
                        schedule = result.data.map(s => ({
                            ...s,
                            id: s.id,
                            startTime: s.startTime || s.time,
                            endTime: s.endTime || (s.time && s.duration ? this.calculateEndTime(s.time, s.duration) : s.time)
                        }));
                        if (typeof filterSchedule === 'function') filterSchedule();
                    }
                });

                // Payments listener
                window.firebaseDBInstance.onPaymentsUpdate((result) => {
                    if (result.success) {
                        payments = result.data.map(p => ({
                            ...p,
                            id: p.id,
                            date: p.date || (p.createdAt?.toDate ? p.createdAt.toDate().toISOString().split('T')[0] : new Date().toISOString().split('T')[0])
                        }));
                        if (typeof filterPayments === 'function') filterPayments();
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    }
                });

                // Admissions listener
                window.firebaseDBInstance.onAdmissionsUpdate((result) => {
                    if (result.success) {
                        // Update enrollment applications list if function exists
                        if (typeof viewEnrollmentApplications === 'function') {
                            // This will be called when viewing enrollments
                        }
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    }
                });

                // Contacts listener
                window.firebaseDBInstance.onContactsUpdate((result) => {
                    if (result.success) {
                        // Update contacts list if needed
                        if (typeof updateDashboardStats === 'function') updateDashboardStats();
                    }
                });
            },

            calculateEndTime(startTime, duration) {
                // Simple calculation - can be enhanced
                const [hours, minutes] = startTime.split(':').map(Number);
                const durationHours = parseInt(duration) || 1;
                const endHours = hours + durationHours;
                return `${endHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            },

            // Get data from Firestore (fallback if listeners haven't loaded yet)
            async getStudents() {
                if (!window.firebaseDBInstance) return [];
                const result = await window.firebaseDBInstance.getAllStudents();
                return result.success ? result.data : [];
            },
            async getClasses() {
                if (!window.firebaseDBInstance) return [];
                const result = await window.firebaseDBInstance.getAllClasses();
                return result.success ? result.data : [];
            },
            async getInstructors() {
                if (!window.firebaseDBInstance) return [];
                const result = await window.firebaseDBInstance.getAllInstructors();
                return result.success ? result.data : [];
            },
            async getSchedule() {
                if (!window.firebaseDBInstance) return [];
                const result = await window.firebaseDBInstance.getAllSchedules();
                return result.success ? result.data : [];
            },
            async getPayments() {
                if (!window.firebaseDBInstance) return [];
                const result = await window.firebaseDBInstance.getAllPayments();
                return result.success ? result.data : [];
            },
            
            // Save data to Firestore
            async saveStudents(data) {
                // Data is saved via individual CRUD operations, not bulk
                // This is kept for compatibility but doesn't do bulk saves
                console.log('saveStudents called - use individual CRUD operations instead');
            },
            async saveClasses(data) {
                console.log('saveClasses called - use individual CRUD operations instead');
            },
            async saveInstructors(data) {
                console.log('saveInstructors called - use individual CRUD operations instead');
            },
            async saveSchedule(data) {
                console.log('saveSchedule called - use individual CRUD operations instead');
            },
            async savePayments(data) {
                console.log('savePayments called - use individual CRUD operations instead');
            },
            
            // Get next ID - not needed with Firestore (uses auto-generated IDs)
            getNextId(data) {
                // Firestore generates IDs automatically, but keep for compatibility
                return data.length > 0 ? Math.max(...data.map(item => item.id ? parseInt(item.id) : 0)) + 1 : 1;
            }
        };

        // Initialize data - wait for Firebase
        let firebaseInitInterval = setInterval(() => {
            if (window.firebaseDBInstance && window.firebaseDb) {
                clearInterval(firebaseInitInterval);
                DataManager.init();
            }
        }, 100);
        
        // Timeout after 10 seconds
        setTimeout(() => {
            clearInterval(firebaseInitInterval);
            if (!window.firebaseDBInstance) {
                console.error('Firebase initialization timeout');
            }
        }, 10000);
        
        // Initialize data arrays (will be populated by Firestore listeners)
        let students = [];
        let classes = [];
        let instructors = [];
        let schedule = [];
        let payments = [];
        
        // Load initial data from Firestore (listeners will keep it updated)
        async function loadInitialData() {
            if (window.firebaseDBInstance) {
                students = await DataManager.getStudents();
                classes = await DataManager.getClasses();
                instructors = await DataManager.getInstructors();
                schedule = await DataManager.getSchedule();
                payments = await DataManager.getPayments();
                
                // Initialize tables with loaded data
                if (typeof initializeTables === 'function') {
                    initializeTables();
                }
            }
        }
        
        // Wait for Firebase and load data
        let loadDataInterval = setInterval(async () => {
            if (window.firebaseDBInstance && window.firebaseDb) {
                clearInterval(loadDataInterval);
                await loadInitialData();
            }
        }, 100);
        
        setTimeout(() => {
            clearInterval(loadDataInterval);
        }, 10000);

        // Recent activities - will be populated dynamically from Firestore data
        let recentActivities = [];
        
        // Function to generate recent activities from actual data
        function generateRecentActivities() {
            const activities = [];
            const config = window.AdminConfig || {};
            
            // Get recent students (if any)
            if (students && students.length > 0) {
                const recentStudent = students[0];
                activities.push({
                    type: "enrollment",
                    title: "New Student Registration",
                    description: `${recentStudent.firstName} ${recentStudent.lastName} registered for ${recentStudent.class}`,
                    time: "Recently",
                    icon: "user-plus",
                    color: "primary"
                });
            }
            
            // Get recent payments (if any)
            if (payments && payments.length > 0) {
                const recentPayment = payments[0];
                activities.push({
                    type: "payment",
                    title: "Payment Received",
                    description: `${recentPayment.student} completed payment for ${recentPayment.class}`,
                    time: "Recently",
                    icon: "money-check",
                    color: "success"
                });
            }
            
            // Get recent instructors (if any)
            if (instructors && instructors.length > 0) {
                const recentInstructor = instructors[0];
                activities.push({
                    type: "instructor",
                    title: "New Instructor",
                    description: `${recentInstructor.firstName} ${recentInstructor.lastName} joined as instructor`,
                    time: "Recently",
                    icon: "chalkboard-teacher",
                    color: "warning"
                });
            }
            
            // Get recent classes (if any)
            if (classes && classes.length > 0) {
                const recentClass = classes[0];
                activities.push({
                    type: "class",
                    title: "New Class Added",
                    description: `${recentClass.name} class is now available`,
                    time: "Recently",
                    icon: "book",
                    color: "info"
                });
            }
            
            // If no activities, show placeholder
            if (activities.length === 0) {
                activities.push({
                    type: "info",
                    title: "Welcome!",
                    description: "Start by adding students, classes, or other data to see recent activities here.",
                    time: "Now",
                    icon: "info-circle",
                    color: "info"
                });
            }
            
            return activities.slice(0, config.dashboard?.recentItemsLimit || 5);
        }

        // DOM Elements
        const sidebarItems = document.querySelectorAll('.sidebar-menu li');
        const pages = document.querySelectorAll('.page');
        const pageTitle = document.getElementById('page-title');

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Reset form
            const form = document.getElementById(modalId).querySelector('form');
            if (form) {
                form.reset();
                const hiddenId = form.querySelector('input[type="hidden"]');
                if (hiddenId) hiddenId.value = '';
            }
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Refresh data from Firestore (async)
        async function refreshData() {
            if (window.firebaseDBInstance) {
                students = await DataManager.getStudents();
                classes = await DataManager.getClasses();
                instructors = await DataManager.getInstructors();
                schedule = await DataManager.getSchedule();
                payments = await DataManager.getPayments();
            }
        }

        // Initialize data tables
        async function initializeTables() {
            await refreshData();
            
            // Use filter functions to display data (which will show all if no filters are active)
            filterStudents();
            filterClasses();
            filterInstructors();
            filterSchedule();
            filterPayments();
            
            // Also update recent enrollments
            const recentEnrollmentsTable = document.getElementById('recentEnrollmentsTable');
            if (recentEnrollmentsTable) {
                recentEnrollmentsTable.innerHTML = '';
                students.slice(0, 5).forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.class}</td>
                        <td>${student.enrollmentDate}</td>
                        <td><span class="status status-${student.status.toLowerCase()}">${student.status}</span></td>
                    `;
                    recentEnrollmentsTable.appendChild(row);
                });
            }
            
            // Update recent activities
            const recentActivitiesList = document.getElementById('recentActivitiesList');
            if (recentActivitiesList) {
                recentActivitiesList.innerHTML = '';
                recentActivities = generateRecentActivities();
                recentActivities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    item.innerHTML = `
                        <div class="activity-icon bg-${activity.color}-light">
                            <i class="fas fa-${activity.icon}"></i>
                        </div>
                        <div class="activity-info">
                            <h4>${activity.title}</h4>
                            <p>${activity.description}</p>
                        </div>
                        <div class="activity-time">${activity.time}</div>
                    `;
                    recentActivitiesList.appendChild(item);
                });
            }
            
            // Update dashboard stats
            updateDashboardStats();
        }

        // Helper function to format time
        function formatTime(timeStr) {
            if (!timeStr) return '';
            if (timeStr.includes('AM') || timeStr.includes('PM')) return timeStr;
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Helper function to parse time for input
        function parseTime(timeStr) {
            if (!timeStr) return '';
            if (timeStr.includes('AM') || timeStr.includes('PM')) {
                const [time, period] = timeStr.split(' ');
                const [hours, minutes] = time.split(':');
                let hour = parseInt(hours);
                if (period === 'PM' && hour !== 12) hour += 12;
                if (period === 'AM' && hour === 12) hour = 0;
                return `${hour.toString().padStart(2, '0')}:${minutes}`;
            }
            return timeStr;
        }

        // ========== STUDENT CRUD OPERATIONS ==========
        function addStudent() {
            document.getElementById('studentModalTitle').textContent = 'Add Student';
            document.getElementById('studentId').value = '';
            openModal('studentModal');
        }

        async function editStudent(id) {
            await refreshData();
            const student = students.find(s => s.id === id || s.id === id.toString());
            if (!student) return;
            
            document.getElementById('studentModalTitle').textContent = 'Edit Student';
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentFirstName').value = student.firstName;
            document.getElementById('studentLastName').value = student.lastName;
            document.getElementById('studentEmail').value = student.email;
            document.getElementById('studentClass').value = student.class;
            document.getElementById('studentEnrollmentDate').value = student.enrollmentDate;
            document.getElementById('studentStatus').value = student.status;
            openModal('studentModal');
        }

        async function deleteStudent(id) {
            const config = window.AdminConfig || {};
            const confirmMsg = config.messages?.confirm?.delete || "Are you sure? This action cannot be undone!";
            Swal.fire({
                title: 'Are you sure?',
                text: confirmMsg,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: config.charts?.colors?.primary || '#4361ee',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    if (!window.firebaseDBInstance) {
                        Swal.fire('Error', 'Database not initialized.', 'error');
                        return;
                    }
                    
                    await refreshData();
                    const student = students.find(s => s.id === id || s.id === id.toString());
                    
                    try {
                        const config = window.AdminConfig || {};
                        const deleteResult = await window.firebaseDBInstance.deleteStudent(id);
                        if (deleteResult.success) {
                            const msg = config.messages?.success?.deleted || 'has been deleted successfully.';
                            Swal.fire('Deleted!', `Student ${msg}`, 'success');
                            if (student) {
                                createNotification(
                                    'Student Deleted',
                                    `${student.firstName} ${student.lastName} has been removed from the system.`,
                                    'warning'
                                );
                            }
                            // Data will be updated automatically by real-time listener
                        } else {
                            throw new Error(deleteResult.error || (config.messages?.error?.delete || 'Delete failed'));
                        }
                    } catch (error) {
                        console.error('Error deleting student:', error);
                        const config = window.AdminConfig || {};
                        Swal.fire('Error', error.message || (config.messages?.error?.delete || 'Failed to delete student.'), 'error');
                    }
                }
            });
        }

        // ========== GES SUBJECTS MANAGEMENT ==========
        // Use subjects from AdminConfig
        const GESSubjects = window.AdminConfig ? window.AdminConfig.gesSubjects : {};

        function updateClassSubjects() {
            const className = document.getElementById('className').value;
            const container = document.getElementById('classSubjectsContainer');
            
            if (!className) {
                container.innerHTML = '<p class="form-text" style="color: #6c757d; font-size: 0.9rem;">Select a class to view available subjects</p>';
                return;
            }
            
            const subjects = GESSubjects[className];
            if (!subjects) {
                container.innerHTML = '<p class="form-text" style="color: #d33; font-size: 0.9rem;">No subjects found for this class</p>';
                return;
            }
            
            let html = '';
            
            // Check if it's JHS (has core and elective structure)
            if (className.startsWith('JHS')) {
                html = `
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: 600; color: var(--dark); margin-bottom: 10px; display: block;">Core Subjects (Mandatory)</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                            ${subjects.core.map(subject => `
                                <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; cursor: pointer;">
                                    <input type="checkbox" name="classSubject" value="${subject}" checked style="margin-right: 8px;" disabled>
                                    <span>${subject}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <label style="font-weight: 600; color: var(--dark); margin-bottom: 10px; display: block;">Elective Subjects (Select at least one)</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                            ${subjects.elective.map(subject => `
                                <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; cursor: pointer;">
                                    <input type="checkbox" name="classSubject" value="${subject}" style="margin-right: 8px;">
                                    <span>${subject}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // KG and Primary - all subjects are mandatory
                html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
                        ${subjects.map(subject => `
                            <label style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" name="classSubject" value="${subject}" checked style="margin-right: 8px;">
                                <span>${subject}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // ========== CLASS CRUD OPERATIONS ==========
        function addClass() {
            document.getElementById('classModalTitle').textContent = 'Add Class';
            document.getElementById('classId').value = '';
            document.getElementById('className').value = '';
            document.getElementById('classSubjectsContainer').innerHTML = '<p class="form-text" style="color: #6c757d; font-size: 0.9rem;">Select a class to view available subjects</p>';
            openModal('classModal');
        }

        async function editClass(id) {
            await refreshData();
            const classItem = classes.find(c => c.id === id || c.id === id.toString());
            if (!classItem) return;
            
            document.getElementById('classModalTitle').textContent = 'Edit Class';
            document.getElementById('classId').value = classItem.id;
            document.getElementById('className').value = classItem.name;
            document.getElementById('classCapacity').value = classItem.capacity;
            document.getElementById('classInstructors').value = Array.isArray(classItem.instructors) ? classItem.instructors.join(', ') : (classItem.instructors || '');
            document.getElementById('classStatus').value = classItem.status;
            
            // Update subjects display
            updateClassSubjects();
            
            // Restore selected subjects if they exist
            if (classItem.subjects && classItem.subjects.length > 0) {
                setTimeout(() => {
                    classItem.subjects.forEach(subject => {
                        const checkbox = document.querySelector(`input[name="classSubject"][value="${subject}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }, 100);
            }
            
            openModal('classModal');
        }

        async function deleteClass(id) {
            const config = window.AdminConfig || {};
            const confirmMsg = config.messages?.confirm?.delete || "Are you sure? This action cannot be undone!";
            Swal.fire({
                title: 'Are you sure?',
                text: confirmMsg,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: config.charts?.colors?.primary || '#4361ee',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    if (!window.firebaseDBInstance) {
                        Swal.fire('Error', 'Database not initialized.', 'error');
                        return;
                    }
                    
                    await refreshData();
                    const classItem = classes.find(c => c.id === id || c.id === id.toString());
                    
                    try {
                        const config = window.AdminConfig || {};
                        const deleteResult = await window.firebaseDBInstance.deleteClass(id);
                        if (deleteResult.success) {
                            const msg = config.messages?.success?.deleted || 'has been deleted successfully.';
                            Swal.fire('Deleted!', `Class ${msg}`, 'success');
                            if (classItem) {
                                createNotification(
                                    'Class Deleted',
                                    `${classItem.name} has been removed from the system.`,
                                    'warning'
                                );
                            }
                        } else {
                            throw new Error(deleteResult.error || (config.messages?.error?.delete || 'Delete failed'));
                        }
                    } catch (error) {
                        console.error('Error deleting class:', error);
                        const config = window.AdminConfig || {};
                        Swal.fire('Error', error.message || (config.messages?.error?.delete || 'Failed to delete class.'), 'error');
                    }
                }
            });
        }

        // ========== INSTRUCTOR CRUD OPERATIONS ==========
        function addInstructor() {
            document.getElementById('instructorModalTitle').textContent = 'Add Instructor';
            document.getElementById('instructorId').value = '';
            openModal('instructorModal');
        }

        async function editInstructor(id) {
            await refreshData();
            const instructor = instructors.find(i => i.id === id || i.id === id.toString());
            if (!instructor) return;
            
            document.getElementById('instructorModalTitle').textContent = 'Edit Instructor';
            document.getElementById('instructorId').value = instructor.id;
            document.getElementById('instructorFirstName').value = instructor.firstName;
            document.getElementById('instructorLastName').value = instructor.lastName;
            document.getElementById('instructorEmail').value = instructor.email;
            document.getElementById('instructorSpecialization').value = instructor.specialization;
            document.getElementById('instructorClasses').value = Array.isArray(instructor.classes) ? instructor.classes.join(', ') : (instructor.classes || '');
            document.getElementById('instructorStatus').value = instructor.status;
            openModal('instructorModal');
        }

        async function deleteInstructor(id) {
            const config = window.AdminConfig || {};
            const confirmMsg = config.messages?.confirm?.delete || "Are you sure? This action cannot be undone!";
            Swal.fire({
                title: 'Are you sure?',
                text: confirmMsg,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: config.charts?.colors?.primary || '#4361ee',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    if (!window.firebaseDBInstance) {
                        Swal.fire('Error', 'Database not initialized.', 'error');
                        return;
                    }
                    
                    await refreshData();
                    const instructor = instructors.find(i => i.id === id || i.id === id.toString());
                    
                    try {
                        const config = window.AdminConfig || {};
                        const deleteResult = await window.firebaseDBInstance.deleteInstructor(id);
                        if (deleteResult.success) {
                            const msg = config.messages?.success?.deleted || 'has been deleted successfully.';
                            Swal.fire('Deleted!', `Instructor ${msg}`, 'success');
                            if (instructor) {
                                createNotification(
                                    'Instructor Deleted',
                                    `${instructor.firstName} ${instructor.lastName} has been removed from the system.`,
                                    'warning'
                                );
                            }
                        } else {
                            throw new Error(deleteResult.error || (config.messages?.error?.delete || 'Delete failed'));
                        }
                    } catch (error) {
                        console.error('Error deleting instructor:', error);
                        const config = window.AdminConfig || {};
                        Swal.fire('Error', error.message || (config.messages?.error?.delete || 'Failed to delete instructor.'), 'error');
                    }
                }
            });
        }

        // ========== SCHEDULE CRUD OPERATIONS ==========
        function addSchedule() {
            document.getElementById('scheduleModalTitle').textContent = 'Add Schedule';
            document.getElementById('scheduleId').value = '';
            openModal('scheduleModal');
        }

        async function editSchedule(id) {
            await refreshData();
            const scheduleItem = schedule.find(s => s.id === id || s.id === id.toString());
            if (!scheduleItem) return;
            
            document.getElementById('scheduleModalTitle').textContent = 'Edit Schedule';
            document.getElementById('scheduleId').value = scheduleItem.id;
            document.getElementById('scheduleClass').value = scheduleItem.class;
            document.getElementById('scheduleInstructor').value = scheduleItem.instructor;
            document.getElementById('scheduleDay').value = scheduleItem.day;
            document.getElementById('scheduleTime').value = parseTime(scheduleItem.time || scheduleItem.startTime);
            document.getElementById('scheduleDuration').value = scheduleItem.duration;
            openModal('scheduleModal');
        }

        async function deleteSchedule(id) {
            const config = window.AdminConfig || {};
            const confirmMsg = config.messages?.confirm?.delete || "Are you sure? This action cannot be undone!";
            Swal.fire({
                title: 'Are you sure?',
                text: confirmMsg,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: config.charts?.colors?.primary || '#4361ee',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    if (!window.firebaseDBInstance) {
                        Swal.fire('Error', 'Database not initialized.', 'error');
                        return;
                    }
                    
                    await refreshData();
                    const scheduleItem = schedule.find(s => s.id === id || s.id === id.toString());
                    
                    try {
                        const config = window.AdminConfig || {};
                        const deleteResult = await window.firebaseDBInstance.deleteSchedule(id);
                        if (deleteResult.success) {
                            const msg = config.messages?.success?.deleted || 'has been deleted successfully.';
                            Swal.fire('Deleted!', `Schedule ${msg}`, 'success');
                            if (scheduleItem) {
                                createNotification(
                                    'Schedule Deleted',
                                    `Schedule for ${scheduleItem.class} on ${scheduleItem.day} has been removed.`,
                                    'warning'
                                );
                            }
                        } else {
                            throw new Error(deleteResult.error || (config.messages?.error?.delete || 'Delete failed'));
                        }
                    } catch (error) {
                        console.error('Error deleting schedule:', error);
                        const config = window.AdminConfig || {};
                        Swal.fire('Error', error.message || (config.messages?.error?.delete || 'Failed to delete schedule.'), 'error');
                    }
                }
            });
        }

        // ========== PAYMENT CRUD OPERATIONS ==========
        function addPayment() {
            document.getElementById('paymentModalTitle').textContent = 'Add Payment';
            document.getElementById('paymentId').value = '';
            openModal('paymentModal');
        }

        async function editPayment(id) {
            await refreshData();
            const payment = payments.find(p => p.id === id || p.id === id.toString());
            if (!payment) return;
            
            document.getElementById('paymentModalTitle').textContent = 'Edit Payment';
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('paymentStudent').value = payment.student;
            document.getElementById('paymentClass').value = payment.class;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentDate').value = payment.date;
            document.getElementById('paymentStatus').value = payment.status;
            openModal('paymentModal');
        }

        async function deletePayment(id) {
            const config = window.AdminConfig || {};
            const confirmMsg = config.messages?.confirm?.delete || "Are you sure? This action cannot be undone!";
            Swal.fire({
                title: 'Are you sure?',
                text: confirmMsg,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: config.charts?.colors?.primary || '#4361ee',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    if (!window.firebaseDBInstance) {
                        Swal.fire('Error', 'Database not initialized.', 'error');
                        return;
                    }
                    
                    await refreshData();
                    const payment = payments.find(p => p.id === id || p.id === id.toString());
                    
                    try {
                        const config = window.AdminConfig || {};
                        const deleteResult = await window.firebaseDBInstance.deletePayment(id);
                        if (deleteResult.success) {
                            const msg = config.messages?.success?.deleted || 'has been deleted successfully.';
                            const currency = config.helpers?.formatCurrency ? config.helpers.formatCurrency(payment.amount) : `$${payment.amount}`;
                            Swal.fire('Deleted!', `Payment ${msg}`, 'success');
                            if (payment) {
                                createNotification(
                                    'Payment Deleted',
                                    `Payment of ${currency} from ${payment.student} has been removed.`,
                                    'warning'
                                );
                            }
                        } else {
                            throw new Error(deleteResult.error || (config.messages?.error?.delete || 'Delete failed'));
                        }
                    } catch (error) {
                        console.error('Error deleting payment:', error);
                        const config = window.AdminConfig || {};
                        Swal.fire('Error', error.message || (config.messages?.error?.delete || 'Failed to delete payment.'), 'error');
                    }
                }
            });
        }

        // ========== FORM SUBMISSIONS ==========
        document.getElementById('studentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await refreshData();
            
            if (!window.firebaseDBInstance) {
                Swal.fire('Error', 'Database not initialized. Please refresh and try again.', 'error');
                return;
            }
            
            const id = document.getElementById('studentId').value;
            const studentData = {
                firstName: document.getElementById('studentFirstName').value,
                lastName: document.getElementById('studentLastName').value,
                email: document.getElementById('studentEmail').value,
                class: document.getElementById('studentClass').value,
                enrollmentDate: document.getElementById('studentEnrollmentDate').value,
                status: document.getElementById('studentStatus').value
            };
            
            try {
                if (id) {
                    // Update
                    const result = await window.firebaseDBInstance.updateStudent(id, studentData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.updated || 'has been updated successfully.';
                        Swal.fire('Updated!', `Student ${msg}`, 'success');
                        createNotification(
                            'Student Updated',
                            `${studentData.firstName} ${studentData.lastName} ${msg}`,
                            'success'
                        );
                    } else {
                        throw new Error(result.error || (config.messages?.error?.update || 'Update failed'));
                    }
                } else {
                    // Create
                    const result = await window.firebaseDBInstance.addStudent(studentData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.created || 'has been created successfully.';
                        Swal.fire('Created!', `Student ${msg}`, 'success');
                        createNotification(
                            'New Student Added',
                            `${studentData.firstName} ${studentData.lastName} has been enrolled in ${studentData.class}.`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.create || 'Creation failed'));
                    }
                }
                
                // Data will be updated automatically by real-time listener
                closeModal('studentModal');
            } catch (error) {
                console.error('Error saving student:', error);
                Swal.fire('Error', error.message || 'Failed to save student. Please try again.', 'error');
            }
        });

        document.getElementById('classForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await refreshData();
            
            if (!window.firebaseDBInstance) {
                Swal.fire('Error', 'Database not initialized. Please refresh and try again.', 'error');
                return;
            }
            
            const id = document.getElementById('classId').value;
            const instructorsStr = document.getElementById('classInstructors').value;
            const instructorsList = instructorsStr ? instructorsStr.split(',').map(i => i.trim()).filter(i => i) : [];
            
            // Collect selected subjects
            const selectedSubjects = Array.from(document.querySelectorAll('input[name="classSubject"]:checked'))
                .map(checkbox => checkbox.value);
            
            // For JHS, ensure at least one elective is selected
            const className = document.getElementById('className').value;
            if (className.startsWith('JHS')) {
                const coreSubjects = GESSubjects[className]?.core || [];
                const electiveSubjects = GESSubjects[className]?.elective || [];
                const selectedElectives = selectedSubjects.filter(s => electiveSubjects.includes(s));
                
                if (selectedElectives.length === 0) {
                    const config = window.AdminConfig || {};
                    const msg = config.messages?.error?.validation || 'Please check your input and try again.';
                    Swal.fire('Validation Error', 'Please select at least one elective subject for JHS classes.', 'warning');
                    return;
                }
            }
            
            const classData = {
                name: document.getElementById('className').value,
                capacity: parseInt(document.getElementById('classCapacity').value),
                instructors: instructorsList,
                status: document.getElementById('classStatus').value,
                subjects: selectedSubjects,
                students: id ? classes.find(c => c.id === id || c.id === id.toString())?.students || 0 : 0
            };
            
            try {
                if (id) {
                    // Update
                    const result = await window.firebaseDBInstance.updateClass(id, classData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.updated || 'has been updated successfully.';
                        Swal.fire('Updated!', `Class ${msg}`, 'success');
                        createNotification(
                            'Class Updated',
                            `${classData.name} ${msg}`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.update || 'Update failed'));
                    }
                } else {
                    // Create
                    const result = await window.firebaseDBInstance.addClass(classData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.created || 'has been created successfully.';
                        Swal.fire('Created!', `Class ${msg}`, 'success');
                        createNotification(
                            'New Class Added',
                            `${classData.name} has been created with capacity of ${classData.capacity} students.`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.create || 'Creation failed'));
                    }
                }
                
                closeModal('classModal');
            } catch (error) {
                console.error('Error saving class:', error);
                const config = window.AdminConfig || {};
                Swal.fire('Error', error.message || (config.messages?.error?.update || 'Failed to save class. Please try again.'), 'error');
            }
        });

        document.getElementById('instructorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await refreshData();
            
            if (!window.firebaseDBInstance) {
                Swal.fire('Error', 'Database not initialized. Please refresh and try again.', 'error');
                return;
            }
            
            const id = document.getElementById('instructorId').value;
            const classesStr = document.getElementById('instructorClasses').value;
            const classesList = classesStr ? classesStr.split(',').map(c => c.trim()).filter(c => c) : [];
            
            const instructorData = {
                firstName: document.getElementById('instructorFirstName').value,
                lastName: document.getElementById('instructorLastName').value,
                email: document.getElementById('instructorEmail').value,
                specialization: document.getElementById('instructorSpecialization').value,
                classes: classesList,
                status: document.getElementById('instructorStatus').value
            };
            
            try {
                if (id) {
                    // Update
                    const result = await window.firebaseDBInstance.updateInstructor(id, instructorData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.updated || 'has been updated successfully.';
                        Swal.fire('Updated!', `Instructor ${msg}`, 'success');
                        createNotification(
                            'Instructor Updated',
                            `${instructorData.firstName} ${instructorData.lastName} ${msg}`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.update || 'Update failed'));
                    }
                } else {
                    // Create
                    const result = await window.firebaseDBInstance.addInstructor(instructorData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.created || 'has been created successfully.';
                        Swal.fire('Created!', `Instructor ${msg}`, 'success');
                        createNotification(
                            'New Instructor Added',
                            `${instructorData.firstName} ${instructorData.lastName} has been added as an instructor.`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.create || 'Creation failed'));
                    }
                }
                
                closeModal('instructorModal');
            } catch (error) {
                console.error('Error saving instructor:', error);
                const config = window.AdminConfig || {};
                Swal.fire('Error', error.message || (config.messages?.error?.update || 'Failed to save instructor. Please try again.'), 'error');
            }
        });

        document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await refreshData();
            
            if (!window.firebaseDBInstance) {
                Swal.fire('Error', 'Database not initialized. Please refresh and try again.', 'error');
                return;
            }
            
            const id = document.getElementById('scheduleId').value;
            const timeValue = document.getElementById('scheduleTime').value;
            
            const scheduleData = {
                class: document.getElementById('scheduleClass').value,
                instructor: document.getElementById('scheduleInstructor').value,
                day: document.getElementById('scheduleDay').value,
                startTime: timeValue,
                time: timeValue,
                duration: document.getElementById('scheduleDuration').value
            };
            
            try {
                if (id) {
                    // Update
                    const result = await window.firebaseDBInstance.updateSchedule(id, scheduleData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.updated || 'has been updated successfully.';
                        Swal.fire('Updated!', `Schedule ${msg}`, 'success');
                        createNotification(
                            'Schedule Updated',
                            `Schedule for ${scheduleData.class} on ${scheduleData.day} ${msg}`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.update || 'Update failed'));
                    }
                } else {
                    // Create
                    const result = await window.firebaseDBInstance.addSchedule(scheduleData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.created || 'has been created successfully.';
                        Swal.fire('Created!', `Schedule ${msg}`, 'success');
                        createNotification(
                            'New Schedule Added',
                            `Schedule for ${scheduleData.class} on ${scheduleData.day} at ${scheduleData.time} has been created.`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.create || 'Creation failed'));
                    }
                }
                
                closeModal('scheduleModal');
            } catch (error) {
                console.error('Error saving schedule:', error);
                const config = window.AdminConfig || {};
                Swal.fire('Error', error.message || (config.messages?.error?.update || 'Failed to save schedule. Please try again.'), 'error');
            }
        });

        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await refreshData();
            
            if (!window.firebaseDBInstance) {
                Swal.fire('Error', 'Database not initialized. Please refresh and try again.', 'error');
                return;
            }
            
            const id = document.getElementById('paymentId').value;
            
            const paymentData = {
                student: document.getElementById('paymentStudent').value,
                class: document.getElementById('paymentClass').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                date: document.getElementById('paymentDate').value,
                status: document.getElementById('paymentStatus').value
            };
            
            try {
                if (id) {
                    // Update
                    const result = await window.firebaseDBInstance.updatePayment(id, paymentData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.updated || 'has been updated successfully.';
                        const currency = config.helpers?.formatCurrency ? config.helpers.formatCurrency(paymentData.amount) : `$${paymentData.amount}`;
                        Swal.fire('Updated!', `Payment ${msg}`, 'success');
                        createNotification(
                            'Payment Updated',
                            `Payment for ${paymentData.student} (${currency}) ${msg}`,
                            'success'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.update || 'Update failed'));
                    }
                } else {
                    // Create
                    const result = await window.firebaseDBInstance.addPayment(paymentData);
                    if (result.success) {
                        const config = window.AdminConfig || {};
                        const msg = config.messages?.success?.created || 'has been created successfully.';
                        const currency = config.helpers?.formatCurrency ? config.helpers.formatCurrency(paymentData.amount) : `$${paymentData.amount}`;
                        Swal.fire('Created!', `Payment ${msg}`, 'success');
                        createNotification(
                            'New Payment Added',
                            `Payment of ${currency} from ${paymentData.student} has been recorded.`,
                            paymentData.status === 'Completed' ? 'success' : 'info'
                        );
                    } else {
                        const config = window.AdminConfig || {};
                        throw new Error(result.error || (config.messages?.error?.create || 'Creation failed'));
                    }
                }
                
                closeModal('paymentModal');
            } catch (error) {
                console.error('Error saving payment:', error);
                const config = window.AdminConfig || {};
                Swal.fire('Error', error.message || (config.messages?.error?.update || 'Failed to save payment. Please try again.'), 'error');
            }
        });

        // ========== SEARCH AND FILTER FUNCTIONS ==========
        
        // Global search handler
        function handleGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();
            const activePage = document.querySelector('.page.active');
            
            if (!activePage) return;
            
            const pageId = activePage.id;
            
            switch(pageId) {
                case 'students':
                    document.getElementById('studentSearch').value = searchTerm;
                    filterStudents();
                    break;
                case 'classes':
                    document.getElementById('classSearch').value = searchTerm;
                    filterClasses();
                    break;
                case 'instructors':
                    document.getElementById('instructorSearch').value = searchTerm;
                    filterInstructors();
                    break;
                case 'schedule':
                    document.getElementById('scheduleSearch').value = searchTerm;
                    filterSchedule();
                    break;
                case 'payments':
                    document.getElementById('paymentSearch').value = searchTerm;
                    filterPayments();
                    break;
            }
        }

        // Student Filter Functions
        function filterStudents() {
            refreshData();
            const searchTerm = (document.getElementById('studentSearch')?.value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('studentStatusFilter')?.value || '';
            const classFilter = document.getElementById('studentClassFilter')?.value || '';
            const dateFilter = document.getElementById('studentDateFilter')?.value || '';
            
            let filtered = students.filter(student => {
                const matchesSearch = !searchTerm || 
                    student.firstName.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm) ||
                    student.id.toString().includes(searchTerm);
                
                const matchesStatus = !statusFilter || student.status === statusFilter;
                const matchesClass = !classFilter || student.class === classFilter;
                const matchesDate = !dateFilter || student.enrollmentDate === dateFilter;
                
                return matchesSearch && matchesStatus && matchesClass && matchesDate;
            });
            
            displayFilteredStudents(filtered);
            updateActiveFilters('student', { search: searchTerm, status: statusFilter, class: classFilter, date: dateFilter });
            updateResultsCount('student', filtered.length, students.length);
        }

        function displayFilteredStudents(filtered) {
            const studentsTableBody = document.getElementById('studentsTableBody');
            studentsTableBody.innerHTML = '';
            
            if (filtered.length === 0) {
                const config = window.AdminConfig || {};
                const msg = config.messages?.empty?.students || 'No students found. Add your first student to get started.';
                studentsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-results">
                            <i class="fas fa-search"></i>
                            <p>${msg}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.email}</td>
                    <td>${student.class}</td>
                    <td>${student.enrollmentDate}</td>
                    <td><span class="status status-${student.status.toLowerCase()}">${student.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editStudent(${student.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="deleteStudent(${student.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                studentsTableBody.appendChild(row);
            });
        }

        function clearStudentFilters() {
            document.getElementById('studentSearch').value = '';
            document.getElementById('studentStatusFilter').value = '';
            document.getElementById('studentClassFilter').value = '';
            document.getElementById('studentDateFilter').value = '';
            document.getElementById('globalSearch').value = '';
            filterStudents();
        }

        // Class Filter Functions
        function filterClasses() {
            refreshData();
            const searchTerm = (document.getElementById('classSearch')?.value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('classStatusFilter')?.value || '';
            const capacityFilter = document.getElementById('classCapacityFilter')?.value || '';
            
            let filtered = classes.filter(classItem => {
                const matchesSearch = !searchTerm || 
                    classItem.name.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || classItem.status === statusFilter;
                
                let matchesCapacity = true;
                if (capacityFilter === 'full') {
                    matchesCapacity = classItem.students >= classItem.capacity;
                } else if (capacityFilter === 'available') {
                    matchesCapacity = classItem.students < classItem.capacity;
                }
                
                return matchesSearch && matchesStatus && matchesCapacity;
            });
            
            displayFilteredClasses(filtered);
            updateActiveFilters('class', { search: searchTerm, status: statusFilter, capacity: capacityFilter });
            updateResultsCount('class', filtered.length, classes.length);
        }

        function displayFilteredClasses(filtered) {
            const classesTableBody = document.getElementById('classesTableBody');
            const classCardsContainer = document.querySelector('.class-cards');
            
            classesTableBody.innerHTML = '';
            classCardsContainer.innerHTML = '';
            
            if (filtered.length === 0) {
                const config = window.AdminConfig || {};
                const msg = config.messages?.empty?.classes || 'No classes found. Add your first class to get started.';
                classesTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-results">
                            <i class="fas fa-search"></i>
                            <p>${msg}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach(classItem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${classItem.name}</td>
                    <td>${classItem.students}</td>
                    <td>${classItem.instructors.join(', ')}</td>
                    <td>${classItem.capacity}</td>
                    <td><span class="status status-${classItem.status.toLowerCase()}">${classItem.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editClass(${classItem.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="deleteClass(${classItem.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                classesTableBody.appendChild(row);
                
                const card = document.createElement('div');
                card.className = 'class-card';
                card.innerHTML = `
                    <div class="class-header">
                        <div class="class-name">${classItem.name}</div>
                        <div class="class-stats">
                            <div class="stat">
                                <div class="stat-value">${classItem.students}</div>
                                <div class="stat-label">Students</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${classItem.capacity}</div>
                                <div class="stat-label">Capacity</div>
                            </div>
                        </div>
                    </div>
                    <div class="class-instructors">
                        <div>Instructors:</div>
                        <div class="instructor-list">
                            ${classItem.instructors.map(instructor => `<span class="instructor-tag">${instructor}</span>`).join('')}
                        </div>
                    </div>
                `;
                classCardsContainer.appendChild(card);
            });
        }

        function clearClassFilters() {
            document.getElementById('classSearch').value = '';
            document.getElementById('classStatusFilter').value = '';
            document.getElementById('classCapacityFilter').value = '';
            document.getElementById('globalSearch').value = '';
            filterClasses();
        }

        // Instructor Filter Functions
        function filterInstructors() {
            refreshData();
            const searchTerm = (document.getElementById('instructorSearch')?.value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('instructorStatusFilter')?.value || '';
            const specializationFilter = (document.getElementById('instructorSpecializationFilter')?.value || '').toLowerCase().trim();
            
            let filtered = instructors.filter(instructor => {
                const matchesSearch = !searchTerm || 
                    instructor.firstName.toLowerCase().includes(searchTerm) ||
                    instructor.lastName.toLowerCase().includes(searchTerm) ||
                    instructor.email.toLowerCase().includes(searchTerm) ||
                    instructor.specialization.toLowerCase().includes(searchTerm) ||
                    instructor.id.toString().includes(searchTerm);
                
                const matchesStatus = !statusFilter || instructor.status === statusFilter;
                const matchesSpecialization = !specializationFilter || 
                    instructor.specialization.toLowerCase().includes(specializationFilter);
                
                return matchesSearch && matchesStatus && matchesSpecialization;
            });
            
            displayFilteredInstructors(filtered);
            updateActiveFilters('instructor', { search: searchTerm, status: statusFilter, specialization: specializationFilter });
            updateResultsCount('instructor', filtered.length, instructors.length);
        }

        function displayFilteredInstructors(filtered) {
            const instructorsTableBody = document.getElementById('instructorsTableBody');
            instructorsTableBody.innerHTML = '';
            
            if (filtered.length === 0) {
                const config = window.AdminConfig || {};
                const msg = config.messages?.empty?.instructors || 'No instructors found. Add your first instructor to get started.';
                instructorsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-results">
                            <i class="fas fa-search"></i>
                            <p>${msg}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach(instructor => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${instructor.id}</td>
                    <td>${instructor.firstName} ${instructor.lastName}</td>
                    <td>${instructor.email}</td>
                    <td>${instructor.specialization}</td>
                    <td>${instructor.classes.join(', ')}</td>
                    <td><span class="status status-${instructor.status.toLowerCase()}">${instructor.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editInstructor(${instructor.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="deleteInstructor(${instructor.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                instructorsTableBody.appendChild(row);
            });
        }

        function clearInstructorFilters() {
            document.getElementById('instructorSearch').value = '';
            document.getElementById('instructorStatusFilter').value = '';
            document.getElementById('instructorSpecializationFilter').value = '';
            document.getElementById('globalSearch').value = '';
            filterInstructors();
        }

        // Schedule Filter Functions
        function filterSchedule() {
            refreshData();
            const searchTerm = (document.getElementById('scheduleSearch')?.value || '').toLowerCase().trim();
            const dayFilter = document.getElementById('scheduleDayFilter')?.value || '';
            const classFilter = document.getElementById('scheduleClassFilter')?.value || '';
            
            let filtered = schedule.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.class.toLowerCase().includes(searchTerm) ||
                    item.instructor.toLowerCase().includes(searchTerm);
                
                const matchesDay = !dayFilter || item.day === dayFilter;
                const matchesClass = !classFilter || item.class === classFilter;
                
                return matchesSearch && matchesDay && matchesClass;
            });
            
            displayFilteredSchedule(filtered);
            updateActiveFilters('schedule', { search: searchTerm, day: dayFilter, class: classFilter });
            updateResultsCount('schedule', filtered.length, schedule.length);
        }

        function displayFilteredSchedule(filtered) {
            const scheduleTableBody = document.getElementById('scheduleTableBody');
            scheduleTableBody.innerHTML = '';
            
            if (filtered.length === 0) {
                const config = window.AdminConfig || {};
                const msg = config.messages?.empty?.schedule || 'No schedule found. Add your first schedule to get started.';
                scheduleTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-results">
                            <i class="fas fa-search"></i>
                            <p>${msg}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach(item => {
                const timeDisplay = item.time.includes(':') && !item.time.includes('AM') && !item.time.includes('PM') 
                    ? formatTime(item.time) 
                    : item.time;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.class}</td>
                    <td>${item.instructor}</td>
                    <td>${item.day}</td>
                    <td>${timeDisplay}</td>
                    <td>${item.duration}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editSchedule(${item.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="deleteSchedule(${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                scheduleTableBody.appendChild(row);
            });
        }

        function clearScheduleFilters() {
            document.getElementById('scheduleSearch').value = '';
            document.getElementById('scheduleDayFilter').value = '';
            document.getElementById('scheduleClassFilter').value = '';
            document.getElementById('globalSearch').value = '';
            filterSchedule();
        }

        // Payment Filter Functions
        function filterPayments() {
            refreshData();
            const searchTerm = (document.getElementById('paymentSearch')?.value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('paymentStatusFilter')?.value || '';
            const classFilter = document.getElementById('paymentClassFilter')?.value || '';
            const dateFilter = document.getElementById('paymentDateFilter')?.value || '';
            const amountFilter = document.getElementById('paymentAmountFilter')?.value || '';
            
            let filtered = payments.filter(payment => {
                const matchesSearch = !searchTerm || 
                    payment.student.toLowerCase().includes(searchTerm) ||
                    payment.id.toString().includes(searchTerm);
                
                const matchesStatus = !statusFilter || payment.status === statusFilter;
                const matchesClass = !classFilter || payment.class === classFilter;
                const matchesDate = !dateFilter || payment.date === dateFilter;
                
                let matchesAmount = true;
                if (amountFilter) {
                    const amount = payment.amount || 0;
                    if (amountFilter === '0-1000') {
                        matchesAmount = amount >= 0 && amount <= 1000;
                    } else if (amountFilter === '1000-1500') {
                        matchesAmount = amount > 1000 && amount <= 1500;
                    } else if (amountFilter === '1500+') {
                        matchesAmount = amount > 1500;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesClass && matchesDate && matchesAmount;
            });
            
            displayFilteredPayments(filtered);
            updateActiveFilters('payment', { search: searchTerm, status: statusFilter, class: classFilter, date: dateFilter, amount: amountFilter });
            updateResultsCount('payment', filtered.length, payments.length);
        }

        function displayFilteredPayments(filtered) {
            const paymentsTableBody = document.getElementById('paymentsTableBody');
            paymentsTableBody.innerHTML = '';
            
            if (filtered.length === 0) {
                const config = window.AdminConfig || {};
                const msg = config.messages?.empty?.payments || 'No payments found. Add your first payment to get started.';
                paymentsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-results">
                            <i class="fas fa-search"></i>
                            <p>${msg}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filtered.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${payment.student}</td>
                    <td>${payment.class}</td>
                    <td>$${payment.amount}</td>
                    <td>${payment.date}</td>
                    <td><span class="status status-${payment.status.toLowerCase()}">${payment.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editPayment(${payment.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="deletePayment(${payment.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                paymentsTableBody.appendChild(row);
            });
        }

        function clearPaymentFilters() {
            document.getElementById('paymentSearch').value = '';
            document.getElementById('paymentStatusFilter').value = '';
            document.getElementById('paymentClassFilter').value = '';
            document.getElementById('paymentDateFilter').value = '';
            document.getElementById('paymentAmountFilter').value = '';
            document.getElementById('globalSearch').value = '';
            filterPayments();
        }

        // Helper function to update active filters display
        function updateActiveFilters(entity, filters) {
            const activeFiltersDiv = document.getElementById(`${entity}ActiveFilters`);
            const badgesDiv = document.getElementById(`${entity}FilterBadges`);
            
            if (!activeFiltersDiv || !badgesDiv) return;
            
            const activeFilters = [];
            if (filters.search) activeFilters.push({ label: `Search: "${filters.search}"`, key: 'search' });
            if (filters.status) activeFilters.push({ label: `Status: ${filters.status}`, key: 'status' });
            if (filters.class) activeFilters.push({ label: `Class: ${filters.class}`, key: 'class' });
            if (filters.date) activeFilters.push({ label: `Date: ${filters.date}`, key: 'date' });
            if (filters.day) activeFilters.push({ label: `Day: ${filters.day}`, key: 'day' });
            if (filters.capacity) activeFilters.push({ label: `Capacity: ${filters.capacity}`, key: 'capacity' });
            if (filters.specialization) activeFilters.push({ label: `Specialization: "${filters.specialization}"`, key: 'specialization' });
            if (filters.amount) activeFilters.push({ label: `Amount: ${filters.amount}`, key: 'amount' });
            
            if (activeFilters.length > 0) {
                activeFiltersDiv.style.display = 'block';
                badgesDiv.innerHTML = activeFilters.map(filter => 
                    `<span class="filter-badge">${filter.label} <i class="fas fa-times" onclick="removeFilter('${entity}', '${filter.key}')"></i></span>`
                ).join('');
            } else {
                activeFiltersDiv.style.display = 'none';
                badgesDiv.innerHTML = '';
            }
        }

        // Helper function to remove individual filter
        function removeFilter(entity, filterKey) {
            switch(entity) {
                case 'student':
                    if (filterKey === 'search') document.getElementById('studentSearch').value = '';
                    if (filterKey === 'status') document.getElementById('studentStatusFilter').value = '';
                    if (filterKey === 'class') document.getElementById('studentClassFilter').value = '';
                    if (filterKey === 'date') document.getElementById('studentDateFilter').value = '';
                    filterStudents();
                    break;
                case 'class':
                    if (filterKey === 'search') document.getElementById('classSearch').value = '';
                    if (filterKey === 'status') document.getElementById('classStatusFilter').value = '';
                    if (filterKey === 'capacity') document.getElementById('classCapacityFilter').value = '';
                    filterClasses();
                    break;
                case 'instructor':
                    if (filterKey === 'search') document.getElementById('instructorSearch').value = '';
                    if (filterKey === 'status') document.getElementById('instructorStatusFilter').value = '';
                    if (filterKey === 'specialization') document.getElementById('instructorSpecializationFilter').value = '';
                    filterInstructors();
                    break;
                case 'schedule':
                    if (filterKey === 'search') document.getElementById('scheduleSearch').value = '';
                    if (filterKey === 'day') document.getElementById('scheduleDayFilter').value = '';
                    if (filterKey === 'class') document.getElementById('scheduleClassFilter').value = '';
                    filterSchedule();
                    break;
                case 'payment':
                    if (filterKey === 'search') document.getElementById('paymentSearch').value = '';
                    if (filterKey === 'status') document.getElementById('paymentStatusFilter').value = '';
                    if (filterKey === 'class') document.getElementById('paymentClassFilter').value = '';
                    if (filterKey === 'date') document.getElementById('paymentDateFilter').value = '';
                    if (filterKey === 'amount') document.getElementById('paymentAmountFilter').value = '';
                    filterPayments();
                    break;
            }
        }

        // Helper function to update results count
        function updateResultsCount(entity, filteredCount, totalCount) {
            const resultsCountDiv = document.getElementById(`${entity}ResultsCount`);
            if (resultsCountDiv) {
                if (filteredCount === totalCount) {
                    resultsCountDiv.textContent = `Showing all ${totalCount} ${entity}`;
                } else {
                    resultsCountDiv.textContent = `Showing ${filteredCount} of ${totalCount} ${entity}`;
                }
            }
        }

        // ========== NOTIFICATIONS SYSTEM ==========
        
        // Notification management
        let notifications = JSON.parse(localStorage.getItem('prima_notifications') || '[]');
        let notificationToastContainer = null;
        
        // Initialize notification toast container
        function initNotificationToastContainer() {
            if (!notificationToastContainer) {
                notificationToastContainer = document.createElement('div');
                notificationToastContainer.id = 'notificationToastContainer';
                notificationToastContainer.style.position = 'fixed';
                notificationToastContainer.style.top = '20px';
                notificationToastContainer.style.right = '20px';
                notificationToastContainer.style.zIndex = '10000';
                notificationToastContainer.style.display = 'flex';
                notificationToastContainer.style.flexDirection = 'column';
                notificationToastContainer.style.gap = '10px';
                document.body.appendChild(notificationToastContainer);
            }
        }
        
        // Create a new notification
        function createNotification(title, message, type = 'info', showToast = true) {
            const notification = {
                id: Date.now() + Math.random(),
                title: title,
                message: message,
                type: type, // 'success', 'info', 'warning', 'error'
                read: false,
                timestamp: new Date().toISOString(),
                createdAt: new Date()
            };
            
            notifications.unshift(notification);
            
            // Keep only last 100 notifications
            if (notifications.length > 100) {
                notifications = notifications.slice(0, 100);
            }
            
            localStorage.setItem('prima_notifications', JSON.stringify(notifications));
            
            // Show toast notification
            if (showToast) {
                showNotificationToast(notification);
            }
            
            // Update UI
            updateNotificationBadge();
            renderNotifications();
            
            return notification;
        }
        
        // Show toast notification
        function showNotificationToast(notification) {
            initNotificationToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `notification-toast ${notification.type}`;
            toast.id = `toast-${notification.id}`;
            
            const iconMap = {
                success: 'fa-check-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle'
            };
            
            toast.innerHTML = `
                <div class="notification-toast-icon ${notification.type}">
                    <i class="fas ${iconMap[notification.type] || 'fa-info-circle'}"></i>
                </div>
                <div class="notification-toast-content">
                    <div class="notification-toast-title">${notification.title}</div>
                    <div class="notification-toast-message">${notification.message}</div>
                </div>
                <button class="notification-toast-close" onclick="closeNotificationToast('${notification.id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationToastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                closeNotificationToast(notification.id);
            }, 5000);
        }
        
        // Close toast notification
        function closeNotificationToast(notificationId) {
            const toast = document.getElementById(`toast-${notificationId}`);
            if (toast) {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }
        
        // Toggle notification center
        function toggleNotificationCenter(event) {
            if (event) {
                event.stopPropagation();
            }
            
            const center = document.getElementById('notificationCenter');
            const dropdown = document.getElementById('userProfileDropdown');
            
            if (dropdown) dropdown.classList.remove('active');
            
            if (center) {
                const isActive = center.classList.contains('active');
                // Close all other dropdowns
                document.querySelectorAll('.notification-center.active, .user-profile-dropdown.active').forEach(el => {
                    if (el !== center) el.classList.remove('active');
                });
                
                center.classList.toggle('active');
                if (center.classList.contains('active')) {
                    renderNotifications();
                }
            }
        }
        
        // Close notification center when clicking outside
        document.addEventListener('click', function(event) {
            const notificationIcon = document.querySelector('.notification-icon');
            const notificationCenter = document.getElementById('notificationCenter');
            
            if (notificationIcon && notificationCenter) {
                if (!notificationIcon.contains(event.target) && !notificationCenter.contains(event.target)) {
                    notificationCenter.classList.remove('active');
                }
            }
        });
        
        // Render notifications list
        function renderNotifications() {
            const list = document.getElementById('notificationList');
            if (!list) return;
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            
            notifications.forEach(notification => {
                const timeAgo = getTimeAgo(notification.createdAt);
                const iconMap = {
                    success: 'fa-check-circle',
                    info: 'fa-info-circle',
                    warning: 'fa-exclamation-triangle',
                    error: 'fa-times-circle'
                };
                
                const item = document.createElement('div');
                item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                item.onclick = function(e) {
                    e.stopPropagation();
                    markNotificationAsRead(notification.id);
                };
                
                item.innerHTML = `
                    <div class="notification-icon-wrapper ${notification.type}">
                        <i class="fas ${iconMap[notification.type] || 'fa-info-circle'}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const then = new Date(date);
            const diffInSeconds = Math.floor((now - then) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else if (diffInSeconds < 604800) {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            } else {
                return then.toLocaleDateString();
            }
        }
        
        // Mark notification as read
        function markNotificationAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId || n.id == notificationId);
            if (notification && !notification.read) {
                notification.read = true;
                localStorage.setItem('prima_notifications', JSON.stringify(notifications));
                updateNotificationBadge();
                renderNotifications();
            }
        }
        
        // Mark all notifications as read
        function markAllAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            localStorage.setItem('prima_notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            renderNotifications();
        }
        
        // Clear all notifications
        function clearAllNotifications() {
            Swal.fire({
                title: 'Clear all notifications?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4361ee',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, clear all!'
            }).then((result) => {
                if (result.isConfirmed) {
                    notifications = [];
                    localStorage.setItem('prima_notifications', JSON.stringify(notifications));
                    updateNotificationBadge();
                    renderNotifications();
                    Swal.fire('Cleared!', 'All notifications have been cleared.', 'success');
                }
            });
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // View all notifications (could navigate to a full notifications page)
        function viewAllNotifications() {
            toggleNotificationCenter();
            // In a real app, this would navigate to a full notifications page
            Swal.fire({
                title: 'All Notifications',
                html: `<div style="text-align: left; max-height: 400px; overflow-y: auto;">
                    ${notifications.length === 0 ? '<p>No notifications</p>' : 
                    notifications.map(n => `
                        <div style="padding: 10px; border-bottom: 1px solid #eee;">
                            <strong>${n.title}</strong><br>
                            <small style="color: #6c757d;">${n.message}</small><br>
                            <small style="color: #9ca3af;">${getTimeAgo(n.createdAt)}</small>
                        </div>
                    `).join('')}
                </div>`,
                width: '600px',
                confirmButtonColor: '#4361ee'
            });
        }
        
        // Initialize notifications on page load
        function initializeNotifications() {
            notifications = JSON.parse(localStorage.getItem('prima_notifications') || '[]');
            updateNotificationBadge();
            renderNotifications();
            initNotificationToastContainer();
            
            // Create welcome notification if first time
            if (notifications.length === 0) {
                createNotification(
                    'Welcome to Prima Academy!',
                    'Your admin dashboard is ready. Start managing your academy.',
                    'info',
                    false
                );
            }
        }
        
        // ========== PROFILE AND PASSWORD FORM HANDLERS ==========
        
        // Edit profile form submission
        document.getElementById('editProfileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentUser = JSON.parse(localStorage.getItem('prima_current_user') || '{}');
            const updatedUser = {
                ...currentUser,
                name: document.getElementById('editProfileName').value,
                email: document.getElementById('editProfileEmail').value,
                phone: document.getElementById('editProfilePhone').value,
                role: document.getElementById('editProfileRole').value,
                bio: document.getElementById('editProfileBio').value
            };
            
            localStorage.setItem('prima_current_user', JSON.stringify(updatedUser));
            updateUserDisplay(updatedUser);
            
            Swal.fire({
                icon: 'success',
                title: 'Profile Updated',
                text: 'Your profile has been updated successfully',
                confirmButtonColor: '#4361ee',
                timer: 2000,
                showConfirmButton: false
            });
            
            closeModal('editProfileModal');
        });
        
        // Change password form submission
        document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate password match
            if (newPassword !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Mismatch',
                    text: 'New password and confirm password do not match',
                    confirmButtonColor: '#4361ee'
                });
                return;
            }
            
            // Check password strength
            if (newPassword.length < 8) {
                Swal.fire({
                    icon: 'error',
                    title: 'Weak Password',
                    text: 'Password must be at least 8 characters long',
                    confirmButtonColor: '#4361ee'
                });
                return;
            }
            
            // In a real app, verify current password with server
            // For now, just save the new password
            const passwordData = {
                currentPassword: currentPassword,
                newPassword: newPassword,
                changedAt: new Date().toISOString()
            };
            
            localStorage.setItem('prima_user_password', JSON.stringify(passwordData));
            
            Swal.fire({
                icon: 'success',
                title: 'Password Changed',
                text: 'Your password has been changed successfully',
                confirmButtonColor: '#4361ee',
                timer: 2000,
                showConfirmButton: false
            });
            
            document.getElementById('changePasswordForm').reset();
            closeModal('changePasswordModal');
        });
        
        // ========== BUTTON EVENT HANDLERS ==========
        document.getElementById('addStudentBtn').addEventListener('click', addStudent);
        document.getElementById('addClassBtn').addEventListener('click', addClass);
        document.getElementById('addInstructorBtn').addEventListener('click', addInstructor);
        document.getElementById('addScheduleBtn').addEventListener('click', addSchedule);
        document.getElementById('addPaymentBtn').addEventListener('click', addPayment);

        // Navigation
        sidebarItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.getAttribute('data-page');
                
                // Update active states
                sidebarItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                // Show the selected page
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                // Update page title
                pageTitle.textContent = document.querySelector(`#${pageId} .page-title`).textContent;
            });
        });

        // ========== CHART AND ANALYTICS FUNCTIONS ==========
        
        // Chart instances storage
        let chartInstances = {};
        let customReportChart = null;
        
        // Date range functions
        function setDateRange(range) {
            const today = new Date();
            const startDateInput = document.getElementById('dashboardStartDate');
            const endDateInput = document.getElementById('dashboardEndDate');
            
            // Update active button
            document.querySelectorAll('.date-range-presets .date-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let startDate = new Date();
            let endDate = new Date();
            
            switch(range) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case 'year':
                    startDate = new Date(today);
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
                case 'all':
                    startDate = new Date('2020-01-01');
                    endDate = new Date(today);
                    endDate.setDate(endDate.getDate() + 30);
                    break;
            }
            
            if (startDateInput) startDateInput.value = startDate.toISOString().split('T')[0];
            if (endDateInput) endDateInput.value = endDate.toISOString().split('T')[0];
            
            updateDashboardCharts();
        }
        
        function setReportsDateRange(range) {
            const today = new Date();
            const startDateInput = document.getElementById('reportsStartDate');
            const endDateInput = document.getElementById('reportsEndDate');
            
            // Update active button
            document.querySelectorAll('#reports .date-range-presets .date-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let startDate = new Date();
            let endDate = new Date();
            
            switch(range) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case 'year':
                    startDate = new Date(today);
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
                case 'all':
                    startDate = new Date('2020-01-01');
                    endDate = new Date(today);
                    endDate.setDate(endDate.getDate() + 30);
                    break;
            }
            
            if (startDateInput) startDateInput.value = startDate.toISOString().split('T')[0];
            if (endDateInput) endDateInput.value = endDate.toISOString().split('T')[0];
            
            updateReportsCharts();
        }
        
        // Get filtered data based on date range
        function getFilteredDataByDateRange(startDate, endDate) {
            refreshData();
            
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            
            const filteredStudents = students.filter(s => {
                if (!start || !end) return true;
                const enrollmentDate = new Date(s.enrollmentDate);
                return enrollmentDate >= start && enrollmentDate <= end;
            });
            
            const filteredPayments = payments.filter(p => {
                if (!start || !end) return true;
                const paymentDate = new Date(p.date);
                return paymentDate >= start && paymentDate <= end;
            });
            
            return { filteredStudents, filteredPayments };
        }
        
        // Update dashboard charts
        function updateDashboardCharts() {
            const startDate = document.getElementById('dashboardStartDate')?.value;
            const endDate = document.getElementById('dashboardEndDate')?.value;
            const { filteredStudents, filteredPayments } = getFilteredDataByDateRange(startDate, endDate);
            
            updateEnrollmentChart(filteredStudents);
            updateClassChart();
            updateDashboardStats();
        }
        
        // Update reports charts
        function updateReportsCharts() {
            const startDate = document.getElementById('reportsStartDate')?.value;
            const endDate = document.getElementById('reportsEndDate')?.value;
            const { filteredStudents, filteredPayments } = getFilteredDataByDateRange(startDate, endDate);
            
            updateRevenueChart(filteredPayments);
            updateProgressChart(filteredStudents);
            updatePaymentStatusChart(filteredPayments);
            updateEnrollmentByClassChart(filteredStudents);
        }
        
        // Export chart as image
        function exportChart(canvasId, chartName) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const chart = chartInstances[canvasId];
            if (chart && chart.canvas) {
                // Use Chart.js toBase64Image method
                const url = chart.canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${chartName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = url;
                link.click();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Chart Exported',
                    text: `${chartName} has been exported successfully`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                // Fallback: export canvas directly
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `${chartName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Chart Exported',
                        text: `${chartName} has been exported successfully`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                });
            }
        }
        
        // Export all reports
        function exportAllReports() {
            Swal.fire({
                title: 'Exporting Reports...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            setTimeout(() => {
                const charts = ['revenueChart', 'progressChart', 'paymentStatusChart', 'enrollmentByClassChart'];
                charts.forEach((chartId, index) => {
                    setTimeout(() => {
                        const chartName = chartId.replace('Chart', '').replace(/([A-Z])/g, ' $1').trim();
                        exportChart(chartId, chartName);
                    }, index * 500);
                });
                
                setTimeout(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'All Reports Exported',
                        text: 'All charts have been exported successfully',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }, charts.length * 500);
            }, 500);
        }
        
        // Export dashboard report
        function exportDashboardReport() {
            Swal.fire({
                title: 'Exporting Dashboard...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            setTimeout(() => {
                const charts = ['enrollmentChart', 'classChart'];
                charts.forEach((chartId, index) => {
                    setTimeout(() => {
                        const chartName = chartId.replace('Chart', '').replace(/([A-Z])/g, ' $1').trim();
                        exportChart(chartId, chartName);
                    }, index * 500);
                });
                
                setTimeout(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Dashboard Exported',
                        text: 'Dashboard charts have been exported successfully',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }, charts.length * 500);
            }, 500);
        }
        
        // Custom Report Builder Functions
        function openCustomReportBuilder() {
            document.getElementById('customReportBuilder').style.display = 'block';
            document.getElementById('customReportBuilder').scrollIntoView({ behavior: 'smooth' });
            // Set default dates
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 1);
            document.getElementById('reportStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = endDate.toISOString().split('T')[0];
        }
        
        function closeCustomReportBuilder() {
            document.getElementById('customReportBuilder').style.display = 'none';
        }
        
        let selectedChartType = 'line';
        function selectChartType(type) {
            selectedChartType = type;
            document.querySelectorAll('.chart-type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.chart-type-option').classList.add('selected');
            updateReportPreview();
        }
        
        function updateReportPreview() {
            const metrics = Array.from(document.querySelectorAll('.metric-selector input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (metrics.length === 0) {
                if (customReportChart) {
                    customReportChart.destroy();
                    customReportChart = null;
                }
                return;
            }
            
            const startDate = document.getElementById('reportStartDate')?.value;
            const endDate = document.getElementById('reportEndDate')?.value;
            const { filteredStudents, filteredPayments } = getFilteredDataByDateRange(startDate, endDate);
            
            const ctx = document.getElementById('customReportChart');
            if (!ctx) return;
            
            if (customReportChart) {
                customReportChart.destroy();
            }
            
            let labels = [];
            let datasets = [];
            
            if (metrics.includes('students')) {
                labels = ['Total Students'];
                datasets.push({
                    label: 'Students',
                    data: [filteredStudents.length],
                    backgroundColor: '#4361ee'
                });
            }
            
            if (metrics.includes('payments')) {
                if (labels.length === 0) labels = ['Total Payments'];
                datasets.push({
                    label: 'Payments',
                    data: [filteredPayments.length],
                    backgroundColor: '#4cc9f0'
                });
            }
            
            if (metrics.includes('revenue')) {
                const revenue = filteredPayments
                    .filter(p => p.status === 'Completed')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
                if (labels.length === 0) labels = ['Total Revenue'];
                datasets.push({
                    label: 'Revenue ($)',
                    data: [revenue],
                    backgroundColor: '#f72585'
                });
            }
            
            // Generate monthly data if multiple metrics
            if (metrics.length > 1) {
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                datasets = metrics.map((metric, index) => {
                    const colors = ['#4361ee', '#4cc9f0', '#f72585', '#4895ef', '#7209b7'];
                    return {
                        label: metric.charAt(0).toUpperCase() + metric.slice(1),
                        data: Array(6).fill(0).map(() => Math.floor(Math.random() * 1000) + 100),
                        backgroundColor: colors[index % colors.length]
                    };
                });
            }
            
            customReportChart = new Chart(ctx, {
                type: selectedChartType,
                data: { labels, datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function saveCustomReport() {
            const metrics = Array.from(document.querySelectorAll('.metric-selector input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (metrics.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Metrics Selected',
                    text: 'Please select at least one metric',
                    confirmButtonColor: '#4361ee'
                });
                return;
            }
            
            Swal.fire({
                icon: 'success',
                title: 'Report Saved',
                text: 'Custom report has been saved successfully',
                confirmButtonColor: '#4361ee'
            });
        }
        
        function exportCustomReport() {
            if (!customReportChart) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Chart to Export',
                    text: 'Please generate a report preview first',
                    confirmButtonColor: '#4361ee'
                });
                return;
            }
            
            exportChart('customReportChart', 'Custom Report');
        }
        
        // Update individual charts
        function updateEnrollmentChart(filteredStudents = null) {
            const ctx = document.getElementById('enrollmentChart');
            if (!ctx) return;
            
            const chartType = document.getElementById('enrollmentChartType')?.value || 'line';
            const studentsData = filteredStudents || students;
            
            if (chartInstances.enrollmentChart) {
                chartInstances.enrollmentChart.destroy();
            }
            
            // Generate enrollment data by month
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
            const enrollmentData = months.map(() => Math.floor(Math.random() * 30) + 50);
            
            chartInstances.enrollmentChart = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: months,
                    datasets: [{
                        label: 'New Enrollments',
                        data: enrollmentData,
                        borderColor: '#4361ee',
                        backgroundColor: chartType === 'area' ? 'rgba(67, 97, 238, 0.1)' : '#4361ee',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: chartType === 'area'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function updateClassChart() {
            const ctx = document.getElementById('classChart');
            if (!ctx) return;
            
            const chartType = document.getElementById('classChartType')?.value || 'doughnut';
            
            if (chartInstances.classChart) {
                chartInstances.classChart.destroy();
            }
            
            refreshData();
            
            chartInstances.classChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: classes.map(c => c.name),
                    datasets: [{
                        data: classes.map(c => c.students),
                        backgroundColor: [
                            '#4361ee', '#4cc9f0', '#f72585', '#4895ef', '#3a0ca3',
                            '#7209b7', '#560bad', '#480ca8', '#3a0ca3', '#3f37c9', '#4361ee'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function updateRevenueChart(filteredPayments = null) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            const chartType = document.getElementById('revenueChartType')?.value || 'bar';
            const paymentsData = filteredPayments || payments;
            
            if (chartInstances.revenueChart) {
                chartInstances.revenueChart.destroy();
            }
            
            // Generate revenue data by month
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const revenueData = months.map(() => {
                const completedPayments = paymentsData.filter(p => p.status === 'Completed');
                return completedPayments.reduce((sum, p) => sum + (p.amount || 0), 0) / 6;
            });
            
            chartInstances.revenueChart = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Revenue ($)',
                        data: revenueData,
                        backgroundColor: chartType === 'bar' ? '#4cc9f0' : 'rgba(67, 97, 238, 0.1)',
                        borderColor: '#4361ee',
                        borderWidth: chartType === 'bar' ? 1 : 2,
                        fill: chartType === 'area',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function updateProgressChart(filteredStudents = null) {
            const ctx = document.getElementById('progressChart');
            if (!ctx) return;
            
            const chartType = document.getElementById('progressChartType')?.value || 'pie';
            const studentsData = filteredStudents || students;
            
            if (chartInstances.progressChart) {
                chartInstances.progressChart.destroy();
            }
            
            const active = studentsData.filter(s => s.status === 'Active').length;
            const pending = studentsData.filter(s => s.status === 'Pending').length;
            const inactive = studentsData.filter(s => s.status === 'Inactive').length;
            
            chartInstances.progressChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: ['Active', 'Pending', 'Inactive'],
                    datasets: [{
                        data: [active, pending, inactive],
                        backgroundColor: ['#4361ee', '#4cc9f0', '#f72585'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function updatePaymentStatusChart(filteredPayments = null) {
            const ctx = document.getElementById('paymentStatusChart');
            if (!ctx) return;
            
            if (chartInstances.paymentStatusChart) {
                chartInstances.paymentStatusChart.destroy();
            }
            
            const paymentsData = filteredPayments || payments;
            const completed = paymentsData.filter(p => p.status === 'Completed').length;
            const pending = paymentsData.filter(p => p.status === 'Pending').length;
            const failed = paymentsData.filter(p => p.status === 'Failed').length;
            
            chartInstances.paymentStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending', 'Failed'],
                    datasets: [{
                        data: [completed, pending, failed],
                        backgroundColor: ['#4361ee', '#4cc9f0', '#f72585'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function updateEnrollmentByClassChart(filteredStudents = null) {
            const ctx = document.getElementById('enrollmentByClassChart');
            if (!ctx) return;
            
            if (chartInstances.enrollmentByClassChart) {
                chartInstances.enrollmentByClassChart.destroy();
            }
            
            const studentsData = filteredStudents || students;
            refreshData();
            
            const classCounts = {};
            studentsData.forEach(s => {
                classCounts[s.class] = (classCounts[s.class] || 0) + 1;
            });
            
            chartInstances.enrollmentByClassChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(classCounts),
                    datasets: [{
                        label: 'Students',
                        data: Object.values(classCounts),
                        backgroundColor: '#4361ee',
                        borderColor: '#3f37c9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Initialize charts
        function initializeCharts() {
            // Set default date ranges
            const today = new Date();
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            // Dashboard date range
            const dashboardStartDate = document.getElementById('dashboardStartDate');
            const dashboardEndDate = document.getElementById('dashboardEndDate');
            if (dashboardStartDate && !dashboardStartDate.value) {
                dashboardStartDate.value = oneMonthAgo.toISOString().split('T')[0];
            }
            if (dashboardEndDate && !dashboardEndDate.value) {
                dashboardEndDate.value = today.toISOString().split('T')[0];
            }
            
            // Reports date range
            const reportsStartDate = document.getElementById('reportsStartDate');
            const reportsEndDate = document.getElementById('reportsEndDate');
            if (reportsStartDate && !reportsStartDate.value) {
                reportsStartDate.value = oneMonthAgo.toISOString().split('T')[0];
            }
            if (reportsEndDate && !reportsEndDate.value) {
                reportsEndDate.value = today.toISOString().split('T')[0];
            }
            
            // Initialize dashboard charts
            updateEnrollmentChart();
            updateClassChart();
            
            // Initialize reports charts
            updateRevenueChart();
            updateProgressChart();
            updatePaymentStatusChart();
            updateEnrollmentByClassChart();
        }

        // ========== ENROLLMENT FORM HANDLING ==========
        
        // Handle file uploads for enrollment documents
        function setupEnrollmentFileUploads() {
            const uploadAreas = document.querySelectorAll('.upload-area');
            uploadAreas.forEach((area, index) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.id = `enrollmentFile${index}`;
                input.className = 'enrollment-file-input';
                input.style.display = 'none';
                input.accept = 'image/*,.pdf,.doc,.docx';
                
                area.addEventListener('click', () => {
                    input.click();
                });
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 10 * 1024 * 1024) { // 10MB limit
                            Swal.fire({
                                icon: 'error',
                                title: 'File Too Large',
                                text: 'Please select a file smaller than 10MB',
                                confirmButtonColor: '#4361ee'
                            });
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const fileData = {
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                data: e.target.result
                            };
                            
                            // Store file data
                            area.dataset.fileData = JSON.stringify(fileData);
                            area.querySelector('.upload-text').textContent = ` ${file.name}`;
                            area.style.borderColor = '#4cc9f0';
                            area.style.backgroundColor = 'rgba(76, 201, 240, 0.05)';
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                area.parentElement.appendChild(input);
            });
        }
        
        // Enrollment form submission
        document.getElementById('enrollmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect all form data
            const enrollmentData = {
                id: Date.now(),
                // Student Information
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                middleName: document.getElementById('middleName').value || '',
                dateOfBirth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value,
                nationality: document.getElementById('nationality').value,
                homeAddress: document.getElementById('homeAddress').value,
                city: document.getElementById('city').value,
                postalCode: document.getElementById('postalCode').value,
                gradeLevel: document.getElementById('gradeLevel').value,
                
                // Parent/Guardian Information
                parentFirstName: document.getElementById('parentFirstName').value,
                parentLastName: document.getElementById('parentLastName').value,
                relationship: document.getElementById('relationship').value,
                parentPhone: document.getElementById('parentPhone').value,
                parentEmail: document.getElementById('parentEmail').value,
                parentOccupation: document.getElementById('parentOccupation').value || '',
                parentAddress: document.getElementById('parentAddress').value || '',
                
                // Emergency Contact
                emergencyName: document.getElementById('emergencyName').value,
                emergencyRelationship: document.getElementById('emergencyRelationship').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                emergencyEmail: document.getElementById('emergencyEmail').value || '',
                
                // Academic History
                previousSchool: document.getElementById('previousSchool').value,
                schoolAddress: document.getElementById('schoolAddress').value || '',
                schoolPhone: document.getElementById('schoolPhone').value || '',
                gradeCompleted: document.getElementById('gradeCompleted').value,
                yearsAttended: document.getElementById('yearsAttended').value,
                reasonForLeaving: document.getElementById('reasonForLeaving').value || '',
                specialNeeds: document.getElementById('specialNeeds').value || '',
                extracurricular: document.getElementById('extracurricular').value || '',
                
                // Documents (collect file data)
                documents: [],
                
                // Application metadata
                status: 'Pending',
                submittedAt: new Date().toISOString(),
                submittedDate: new Date().toLocaleDateString()
            };
            
            // Collect uploaded documents
            const uploadAreas = document.querySelectorAll('.upload-area');
            uploadAreas.forEach((area, index) => {
                const fileData = area.dataset.fileData;
                if (fileData) {
                    try {
                        enrollmentData.documents.push(JSON.parse(fileData));
                    } catch (e) {
                        console.error('Error parsing file data:', e);
                    }
                }
            });
            
            // Note: Enrollment applications are saved to Firestore via admission.html
            // This form in admin page is for viewing only - no need to save to localStorage
            // The data is already in Firestore and will be fetched via fetchEnrollmentsFromFirebase()
            
            // Create notification
            createNotification(
                'New Enrollment Application',
                `${enrollmentData.firstName} ${enrollmentData.lastName} has submitted an enrollment application for ${enrollmentData.gradeLevel}.`,
                'info'
            );
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Application Submitted!',
                html: `
                    <p>Your enrollment application has been submitted successfully.</p>
                    <p><strong>Application ID:</strong> ${enrollmentData.id}</p>
                    <p>We will review your application and contact you soon.</p>
                `,
                confirmButtonColor: '#4361ee',
                confirmButtonText: 'OK'
            }).then(() => {
                // Reset form
                document.getElementById('enrollmentForm').reset();
                // Reset upload areas
                uploadAreas.forEach(area => {
                    area.dataset.fileData = '';
                    area.querySelector('.upload-text').textContent = area.querySelector('.upload-text').textContent.replace(' ', '');
                    area.style.borderColor = '#ddd';
                    area.style.backgroundColor = '';
                });
            });
        });

        // ========== AUTHENTICATION AND LOGOUT FUNCTIONS ==========
        
        // Update user display in header
        function updateUserDisplay(userData) {
            const userNameElement = document.getElementById('userProfileName');
            const dropdownUserName = document.getElementById('dropdownUserName');
            const dropdownUserEmail = document.getElementById('dropdownUserEmail');
            
            if (userNameElement && userData.name) {
                userNameElement.textContent = userData.name;
            }
            if (dropdownUserName && userData.name) {
                dropdownUserName.textContent = userData.name;
            }
            if (dropdownUserEmail && userData.email) {
                dropdownUserEmail.textContent = userData.email;
            }
        }

        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userProfileDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userProfile = document.querySelector('.user-profile');
            const dropdown = document.getElementById('userProfileDropdown');
            
            if (userProfile && dropdown && !userProfile.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // View profile function - opens edit profile modal
        function viewProfile() {
            const dropdown = document.getElementById('userProfileDropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            const currentUser = JSON.parse(localStorage.getItem('prima_current_user') || '{}');
            
            // Load user data into form
            document.getElementById('editProfileName').value = currentUser.name || '';
            document.getElementById('editProfileEmail').value = currentUser.email || '';
            document.getElementById('editProfilePhone').value = currentUser.phone || '';
            document.getElementById('editProfileRole').value = currentUser.role || 'admin';
            
            // Load profile picture if exists
            const profilePic = localStorage.getItem('prima_profile_picture');
            if (profilePic) {
                document.getElementById('profilePicturePreview').src = profilePic;
                document.getElementById('userProfileImage').src = profilePic;
            }
            
            openModal('editProfileModal');
        }

        // Open settings function
        function openSettings() {
            const dropdown = document.getElementById('userProfileDropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            // Navigate to settings page
            const settingsItem = document.querySelector('[data-page="settings"]');
            if (settingsItem) {
                settingsItem.click();
            }
            // Initialize settings page
            setTimeout(() => {
                initializeSettingsPage();
            }, 100);
        }
        
        // Open change password modal
        function openChangePasswordModal() {
            const dropdown = document.getElementById('userProfileDropdown');
            if (dropdown) dropdown.classList.remove('active');
            
            document.getElementById('changePasswordForm').reset();
            document.getElementById('passwordStrengthText').textContent = '';
            document.getElementById('passwordMatchText').textContent = '';
            document.getElementById('passwordStrengthBar').className = 'password-strength-fill';
            openModal('changePasswordModal');
        }
        
        // Handle profile picture upload
        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid File',
                    text: 'Please select an image file',
                    confirmButtonColor: '#4361ee'
                });
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                Swal.fire({
                    icon: 'error',
                    title: 'File Too Large',
                    text: 'Please select an image smaller than 5MB',
                    confirmButtonColor: '#4361ee'
                });
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                document.getElementById('profilePicturePreview').src = imageUrl;
                document.getElementById('userProfileImage').src = imageUrl;
                
                // Save to localStorage
                localStorage.setItem('prima_profile_picture', imageUrl);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Picture Updated',
                    text: 'Your profile picture has been updated',
                    timer: 2000,
                    showConfirmButton: false
                });
            };
            reader.readAsDataURL(file);
        }
        
        // Check password strength
        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthText = document.getElementById('passwordStrengthText');
            const strengthBar = document.getElementById('passwordStrengthBar');
            
            if (!password) {
                strengthText.textContent = '';
                strengthBar.className = 'password-strength-fill';
                return;
            }
            
            let strength = 0;
            let feedback = [];
            
            if (password.length >= 8) strength++;
            else feedback.push('at least 8 characters');
            
            if (/[a-z]/.test(password)) strength++;
            else feedback.push('lowercase letter');
            
            if (/[A-Z]/.test(password)) strength++;
            else feedback.push('uppercase letter');
            
            if (/[0-9]/.test(password)) strength++;
            else feedback.push('number');
            
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            else feedback.push('special character');
            
            strengthBar.className = 'password-strength-fill';
            
            if (strength <= 2) {
                strengthText.textContent = 'Weak password. Add: ' + feedback.slice(0, 2).join(', ');
                strengthText.style.color = '#ef233c';
                strengthBar.classList.add('password-strength-weak');
            } else if (strength <= 4) {
                strengthText.textContent = 'Medium password. Add: ' + feedback[0];
                strengthText.style.color = '#f72585';
                strengthBar.classList.add('password-strength-medium');
            } else {
                strengthText.textContent = 'Strong password!';
                strengthText.style.color = '#4cc9f0';
                strengthBar.classList.add('password-strength-strong');
            }
        }
        
        // Check password match
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchText = document.getElementById('passwordMatchText');
            
            if (!confirmPassword) {
                matchText.textContent = '';
                return;
            }
            
            if (newPassword === confirmPassword) {
                matchText.textContent = 'Passwords match';
                matchText.style.color = '#4cc9f0';
            } else {
                matchText.textContent = 'Passwords do not match';
                matchText.style.color = '#ef233c';
            }
        }
        
        // Save account settings
        function saveAccountSetting(key, value) {
            const settings = JSON.parse(localStorage.getItem('prima_account_settings') || '{}');
            settings[key] = value;
            localStorage.setItem('prima_account_settings', JSON.stringify(settings));
        }
        
        // Load account settings
        function loadAccountSettings() {
            const settings = JSON.parse(localStorage.getItem('prima_account_settings') || '{}');
            
            if (settings.emailNotifications !== undefined) {
                document.getElementById('emailNotifications').checked = settings.emailNotifications;
            }
            if (settings.smsNotifications !== undefined) {
                document.getElementById('smsNotifications').checked = settings.smsNotifications;
            }
            if (settings.twoFactorAuth !== undefined) {
                document.getElementById('twoFactorAuth').checked = settings.twoFactorAuth;
            }
            if (settings.autoSave !== undefined) {
                document.getElementById('autoSave').checked = settings.autoSave;
            }
            if (settings.darkMode !== undefined) {
                document.getElementById('darkMode').checked = settings.darkMode;
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                }
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode(enabled) {
            saveAccountSetting('darkMode', enabled);
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
        
        // User roles and permissions
        const rolePermissions = {
            admin: [
                'Manage Students', 'Manage Classes', 'Manage Instructors',
                'Manage Payments', 'View Reports', 'Manage Users',
                'System Settings', 'Export Data', 'Delete Records'
            ],
            instructor: [
                'View Students', 'View Classes', 'View Schedule',
                'View Reports', 'Update Grades'
            ],
            manager: [
                'Manage Students', 'Manage Classes', 'View Reports',
                'Manage Payments', 'Export Data'
            ]
        };
        
        // Initialize user permissions display
        function initializeUserPermissions() {
            const currentUser = JSON.parse(localStorage.getItem('prima_current_user') || '{}');
            const role = currentUser.role || 'admin';
            const permissions = rolePermissions[role] || rolePermissions.admin;
            
            // Update role badge
            const roleBadge = document.getElementById('currentRoleBadge');
            if (roleBadge) {
                roleBadge.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                roleBadge.className = `role-badge role-${role}`;
            }
            
            // Display permissions
            const permissionsGrid = document.getElementById('userPermissionsGrid');
            if (permissionsGrid) {
                permissionsGrid.innerHTML = permissions.map(permission => `
                    <div class="permission-item">
                        <input type="checkbox" checked disabled>
                        <label>${permission}</label>
                    </div>
                `).join('');
            }
        }
        
        // Initialize settings page
        function initializeSettingsPage() {
            loadAccountSettings();
            initializeUserPermissions();
            initializeUsersManagement();
        }
        
        // Users management
        function initializeUsersManagement() {
            const users = JSON.parse(localStorage.getItem('prima_users') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('prima_current_user') || '{}');
            
            // Add current user if not in list
            if (users.length === 0) {
                users.push({
                    id: currentUser.id || 1,
                    username: currentUser.name || 'admin',
                    email: currentUser.email || 'admin@prima.com',
                    role: currentUser.role || 'admin',
                    lastLogin: new Date().toLocaleString(),
                    status: 'Active'
                });
                localStorage.setItem('prima_users', JSON.stringify(users));
            }
            
            const tableBody = document.getElementById('usersManagementTable');
            if (tableBody) {
                tableBody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td><span class="role-badge role-${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span></td>
                        <td>${user.lastLogin}</td>
                        <td><span class="status status-${user.status.toLowerCase()}">${user.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline" onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }
        
        function addNewUser() {
            Swal.fire({
                title: 'Add New User',
                html: `
                    <input id="newUsername" class="swal2-input" placeholder="Username" required>
                    <input id="newUserEmail" class="swal2-input" type="email" placeholder="Email" required>
                    <select id="newUserRole" class="swal2-input">
                        <option value="admin">Administrator</option>
                        <option value="instructor">Instructor</option>
                        <option value="manager">Manager</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Add User',
                confirmButtonColor: '#4361ee',
                preConfirm: () => {
                    return {
                        username: document.getElementById('newUsername').value,
                        email: document.getElementById('newUserEmail').value,
                        role: document.getElementById('newUserRole').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    const users = JSON.parse(localStorage.getItem('prima_users') || '[]');
                    const newUser = {
                        id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                        username: result.value.username,
                        email: result.value.email,
                        role: result.value.role,
                        lastLogin: 'Never',
                        status: 'Active'
                    };
                    users.push(newUser);
                    localStorage.setItem('prima_users', JSON.stringify(users));
                    initializeUsersManagement();
                    Swal.fire('Success!', 'User has been added.', 'success');
                }
            });
        }
        
        function editUser(userId) {
            const users = JSON.parse(localStorage.getItem('prima_users') || '[]');
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            Swal.fire({
                title: 'Edit User',
                html: `
                    <input id="editUsername" class="swal2-input" value="${user.username}" required>
                    <input id="editUserEmail" class="swal2-input" type="email" value="${user.email}" required>
                    <select id="editUserRole" class="swal2-input">
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrator</option>
                        <option value="instructor" ${user.role === 'instructor' ? 'selected' : ''}>Instructor</option>
                        <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                confirmButtonColor: '#4361ee',
                preConfirm: () => {
                    return {
                        username: document.getElementById('editUsername').value,
                        email: document.getElementById('editUserEmail').value,
                        role: document.getElementById('editUserRole').value
                    };
                }
            }).then((result) => {
                if (result.isConfirmed && result.value) {
                    user.username = result.value.username;
                    user.email = result.value.email;
                    user.role = result.value.role;
                    localStorage.setItem('prima_users', JSON.stringify(users));
                    initializeUsersManagement();
                    Swal.fire('Success!', 'User has been updated.', 'success');
                }
            });
        }
        
        function deleteUser(userId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4361ee',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    const users = JSON.parse(localStorage.getItem('prima_users') || '[]');
                    const filtered = users.filter(u => u.id !== userId);
                    localStorage.setItem('prima_users', JSON.stringify(filtered));
                    initializeUsersManagement();
                    Swal.fire('Deleted!', 'User has been deleted.', 'success');
                }
            });
        }
        
        // Save general settings
        function saveGeneralSettings() {
            const settings = {
                academyName: document.getElementById('academyName').value,
                academyEmail: document.getElementById('academyEmail').value,
                academyPhone: document.getElementById('academyPhone').value,
                academyAddress: document.getElementById('academyAddress').value
            };
            
            localStorage.setItem('prima_general_settings', JSON.stringify(settings));
            
            Swal.fire({
                icon: 'success',
                title: 'Settings Saved',
                text: 'General settings have been saved successfully',
                confirmButtonColor: '#4361ee',
                timer: 2000,
                showConfirmButton: false
            });
        }
        
        // ========== ENROLLMENT APPLICATIONS MANAGEMENT ==========
        
        // Fetch enrollments from Firebase
        async function fetchEnrollmentsFromFirebase() {
            try {
                if (!window.firebaseDBInstance) {
                    console.error('Firebase DB not initialized');
                    return [];
                }
                
                const result = await window.firebaseDBInstance.getAllAdmissions();
                if (result && result.success) {
                    // Convert Firebase data to match expected format
                    return result.data.map(enrollment => ({
                        id: enrollment.id,
                        firstName: enrollment.firstName || '',
                        lastName: enrollment.lastName || '',
                        middleName: enrollment.middleName || '',
                        dateOfBirth: enrollment.dateOfBirth || '',
                        gender: enrollment.gender || '',
                        nationality: enrollment.nationality || '',
                        homeAddress: enrollment.homeAddress || '',
                        city: enrollment.city || '',
                        postalCode: enrollment.postalCode || '',
                        gradeLevel: enrollment.gradeLevel || '',
                        parentFirstName: enrollment.parentFirstName || '',
                        parentLastName: enrollment.parentLastName || '',
                        relationship: enrollment.relationship || '',
                        parentPhone: enrollment.parentPhone || '',
                        parentEmail: enrollment.parentEmail || '',
                        parentOccupation: enrollment.parentOccupation || '',
                        parentAddress: enrollment.parentAddress || '',
                        emergencyName: enrollment.emergencyName || '',
                        emergencyRelationship: enrollment.emergencyRelationship || '',
                        emergencyPhone: enrollment.emergencyPhone || '',
                        emergencyEmail: enrollment.emergencyEmail || '',
                        previousSchool: enrollment.previousSchool || '',
                        schoolAddress: enrollment.schoolAddress || '',
                        schoolPhone: enrollment.schoolPhone || '',
                        gradeCompleted: enrollment.gradeCompleted || '',
                        yearsAttended: enrollment.yearsAttended || '',
                        reasonForLeaving: enrollment.reasonForLeaving || '',
                        specialNeeds: enrollment.specialNeeds || '',
                        extracurricular: enrollment.extracurricular || '',
                        documents: enrollment.documents || [],
                        status: enrollment.status || 'Pending',
                        submittedAt: enrollment.submittedAt ? (enrollment.submittedAt.toDate ? enrollment.submittedAt.toDate().toISOString() : enrollment.submittedAt) : new Date().toISOString(),
                        submittedDate: enrollment.submittedDate || (enrollment.submittedAt ? (enrollment.submittedAt.toDate ? enrollment.submittedAt.toDate().toLocaleDateString() : new Date(enrollment.submittedAt).toLocaleDateString()) : new Date().toLocaleDateString()),
                        reviewed: enrollment.reviewed || false
                    }));
                } else {
                    console.error('Error fetching enrollments:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching enrollments from Firebase:', error);
                return [];
            }
        }
        
        // View enrollment applications
        async function viewEnrollmentApplications() {
            // Show loading
            Swal.fire({
                title: 'Loading Applications...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const enrollments = await fetchEnrollmentsFromFirebase();
            
            Swal.close();
            
            if (enrollments.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'No Applications',
                    text: 'There are no enrollment applications yet.',
                    confirmButtonColor: '#4361ee'
                });
                return;
            }
            
            // Create modal content
            const pendingEnrollments = enrollments.filter(e => e.status === 'Pending' || e.status === 'pending');
            const approvedEnrollments = enrollments.filter(e => e.status === 'Approved' || e.status === 'approved');
            const rejectedEnrollments = enrollments.filter(e => e.status === 'Rejected' || e.status === 'rejected');
            
            Swal.fire({
                title: 'Enrollment Applications',
                html: `
                    <div style="text-align: left; max-height: 500px; overflow-y: auto;">
                        <div style="margin-bottom: 20px;">
                            <strong>Total:</strong> ${enrollments.length} | 
                            <span style="color: #f72585;">Pending: ${pendingEnrollments.length}</span> | 
                            <span style="color: #4cc9f0;">Approved: ${approvedEnrollments.length}</span> | 
                            <span style="color: #ef233c;">Rejected: ${rejectedEnrollments.length}</span>
                        </div>
                        <div style="border-top: 1px solid #eee; padding-top: 15px;">
                            ${enrollments.map(enrollment => {
                                const status = enrollment.status || 'Pending';
                                const isPending = status === 'Pending' || status === 'pending';
                                return `
                                <div style="padding: 15px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; background: ${isPending ? '#fff3cd' : status === 'Approved' || status === 'approved' ? '#d4edda' : '#f8d7da'};">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <strong>${enrollment.firstName} ${enrollment.lastName}</strong> 
                                            <span style="color: #6c757d;">(${enrollment.gradeLevel})</span><br>
                                            <small style="color: #6c757d;">
                                                Submitted: ${enrollment.submittedDate} | 
                                                Status: <span style="color: ${isPending ? '#f72585' : status === 'Approved' || status === 'approved' ? '#4cc9f0' : '#ef233c'};">${status}</span>
                                            </small><br>
                                            <small style="color: #6c757d;">
                                                Parent: ${enrollment.parentFirstName} ${enrollment.parentLastName} | 
                                                Email: ${enrollment.parentEmail} | 
                                                Phone: ${enrollment.parentPhone}
                                            </small>
                                        </div>
                                        <div>
                                            <button onclick="viewEnrollmentDetails('${enrollment.id}')" style="padding: 5px 10px; margin: 2px; background: #4361ee; color: white; border: none; border-radius: 3px; cursor: pointer;">View</button>
                                            ${isPending ? `
                                                <button onclick="approveEnrollment('${enrollment.id}')" style="padding: 5px 10px; margin: 2px; background: #4cc9f0; color: white; border: none; border-radius: 3px; cursor: pointer;">Approve</button>
                                                <button onclick="rejectEnrollment('${enrollment.id}')" style="padding: 5px 10px; margin: 2px; background: #ef233c; color: white; border: none; border-radius: 3px; cursor: pointer;">Reject</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `,
                width: '900px',
                showConfirmButton: true,
                confirmButtonText: 'Close',
                confirmButtonColor: '#4361ee'
            });
        }
        
        // View enrollment details
        async function viewEnrollmentDetails(enrollmentId) {
            Swal.fire({
                title: 'Loading...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                if (!window.firebaseDBInstance) {
                    throw new Error('Firebase DB not initialized');
                }
                
                const result = await window.firebaseDBInstance.getAdmission(enrollmentId);
                Swal.close();
                
                if (!result || !result.success || !result.data) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Not Found',
                        text: 'Enrollment application not found',
                        confirmButtonColor: '#4361ee'
                    });
                    return;
                }
                
                const enrollment = result.data;
            
                const status = enrollment.status || 'Pending';
                const isPending = status === 'Pending' || status === 'pending';
                const submittedDate = enrollment.submittedDate || (enrollment.submittedAt ? (enrollment.submittedAt.toDate ? enrollment.submittedAt.toDate().toLocaleDateString() : new Date(enrollment.submittedAt).toLocaleDateString()) : 'N/A');
                
                Swal.fire({
                    title: `Enrollment Application #${enrollmentId}`,
                    html: `
                        <div style="text-align: left; max-height: 600px; overflow-y: auto;">
                            <h4 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 5px;">Student Information</h4>
                            <p><strong>Name:</strong> ${enrollment.firstName || ''} ${enrollment.middleName ? enrollment.middleName + ' ' : ''}${enrollment.lastName || ''}</p>
                            <p><strong>Date of Birth:</strong> ${enrollment.dateOfBirth || 'N/A'}</p>
                            <p><strong>Gender:</strong> ${enrollment.gender || 'N/A'}</p>
                            <p><strong>Nationality:</strong> ${enrollment.nationality || 'N/A'}</p>
                            <p><strong>Address:</strong> ${enrollment.homeAddress || ''}, ${enrollment.city || ''} ${enrollment.postalCode || ''}</p>
                            <p><strong>Applying For:</strong> ${enrollment.gradeLevel || 'N/A'}</p>
                            
                            <h4 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 5px; margin-top: 20px;">Parent/Guardian Information</h4>
                            <p><strong>Name:</strong> ${enrollment.parentFirstName || ''} ${enrollment.parentLastName || ''}</p>
                            <p><strong>Relationship:</strong> ${enrollment.relationship || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${enrollment.parentPhone || 'N/A'}</p>
                            <p><strong>Email:</strong> ${enrollment.parentEmail || 'N/A'}</p>
                            <p><strong>Occupation:</strong> ${enrollment.parentOccupation || 'N/A'}</p>
                            
                            <h4 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 5px; margin-top: 20px;">Emergency Contact</h4>
                            <p><strong>Name:</strong> ${enrollment.emergencyName || 'N/A'}</p>
                            <p><strong>Relationship:</strong> ${enrollment.emergencyRelationship || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${enrollment.emergencyPhone || 'N/A'}</p>
                            <p><strong>Email:</strong> ${enrollment.emergencyEmail || 'N/A'}</p>
                            
                            <h4 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 5px; margin-top: 20px;">Academic History</h4>
                            <p><strong>Previous School:</strong> ${enrollment.previousSchool || 'N/A'}</p>
                            <p><strong>Grade Completed:</strong> ${enrollment.gradeCompleted || 'N/A'}</p>
                            <p><strong>Years Attended:</strong> ${enrollment.yearsAttended || 'N/A'}</p>
                            ${enrollment.reasonForLeaving ? `<p><strong>Reason for Leaving:</strong> ${enrollment.reasonForLeaving}</p>` : ''}
                            ${enrollment.specialNeeds ? `<p><strong>Special Needs:</strong> ${enrollment.specialNeeds}</p>` : ''}
                            ${enrollment.extracurricular ? `<p><strong>Extracurricular:</strong> ${enrollment.extracurricular}</p>` : ''}
                            
                            <h4 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 5px; margin-top: 20px;">Documents</h4>
                            <p>${(enrollment.documents && enrollment.documents.length) || 0} document(s) uploaded</p>
                            ${enrollment.documents && enrollment.documents.length > 0 ? `
                                <ul style="margin-top: 10px;">
                                    ${enrollment.documents.map(doc => `<li><a href="${doc.url || '#'}" target="_blank">${doc.name || 'Document'}</a></li>`).join('')}
                                </ul>
                            ` : ''}
                            
                            <h4 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 5px; margin-top: 20px;">Application Status</h4>
                            <p><strong>Status:</strong> <span style="color: ${isPending ? '#f72585' : status === 'Approved' || status === 'approved' ? '#4cc9f0' : '#ef233c'};">${status}</span></p>
                            <p><strong>Submitted:</strong> ${submittedDate}</p>
                        </div>
                    `,
                    width: '700px',
                    showConfirmButton: true,
                    confirmButtonText: 'Close',
                    confirmButtonColor: '#4361ee',
                    showCancelButton: isPending,
                    cancelButtonText: isPending ? 'Approve' : '',
                    cancelButtonColor: '#4cc9f0'
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        approveEnrollment(enrollmentId);
                    }
                });
            } catch (error) {
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load enrollment details: ' + error.message,
                    confirmButtonColor: '#4361ee'
                });
            }
        }
        
        // Approve enrollment
        async function approveEnrollment(enrollmentId) {
            Swal.fire({
                title: 'Approve Enrollment?',
                text: 'This will create a student record and approve the enrollment application.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4cc9f0',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Approve'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Processing...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    try {
                        if (!window.firebaseDBInstance) {
                            throw new Error('Firebase DB not initialized');
                        }
                        
                        // Get enrollment data from Firebase
                        const enrollmentResult = await window.firebaseDBInstance.getAdmission(enrollmentId);
                        if (!enrollmentResult || !enrollmentResult.success || !enrollmentResult.data) {
                            throw new Error('Enrollment application not found');
                        }
                        
                        const enrollment = enrollmentResult.data;
                        
                        // Update enrollment status in Firebase
                        await window.firebaseDBInstance.updateAdmissionStatus(enrollmentId, 'Approved');
                        
                        // Also update additional fields
                        await window.firebaseDb.collection('admissions').doc(enrollmentId).update({
                            approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            approvedDate: new Date().toLocaleDateString(),
                            reviewed: true
                        });
                        
                        // Create student record in localStorage (for admin dashboard)
                        refreshData();
                        const newStudent = {
                            id: DataManager.getNextId(students),
                            firstName: enrollment.firstName || '',
                            lastName: enrollment.lastName || '',
                            email: enrollment.parentEmail || '', // Use parent email as student email
                            class: enrollment.gradeLevel || '',
                            enrollmentDate: new Date().toISOString().split('T')[0],
                            status: 'Active',
                            // Additional fields from enrollment
                            dateOfBirth: enrollment.dateOfBirth || '',
                            gender: enrollment.gender || '',
                            nationality: enrollment.nationality || '',
                            address: `${enrollment.homeAddress || ''}, ${enrollment.city || ''} ${enrollment.postalCode || ''}`,
                            parentName: `${enrollment.parentFirstName || ''} ${enrollment.parentLastName || ''}`,
                            parentPhone: enrollment.parentPhone || '',
                            parentEmail: enrollment.parentEmail || '',
                            emergencyContact: `${enrollment.emergencyName || ''} (${enrollment.emergencyRelationship || ''}) - ${enrollment.emergencyPhone || ''}`,
                            previousSchool: enrollment.previousSchool || '',
                            specialNeeds: enrollment.specialNeeds || '',
                            enrollmentApplicationId: enrollmentId
                        };
                        
                        students.push(newStudent);
                        DataManager.saveStudents(students);
                        
                        // Create notification
                        createNotification(
                            'Enrollment Approved',
                            `${enrollment.firstName} ${enrollment.lastName} has been enrolled in ${enrollment.gradeLevel}. Student record created.`,
                            'success'
                        );
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Enrollment Approved!',
                            html: `
                                <p>${enrollment.firstName} ${enrollment.lastName} has been successfully enrolled.</p>
                                <p><strong>Student ID:</strong> ${newStudent.id}</p>
                                <p><strong>Class:</strong> ${enrollment.gradeLevel}</p>
                            `,
                            confirmButtonColor: '#4361ee'
                        }).then(() => {
                            // Refresh tables
                            initializeTables();
                            viewEnrollmentApplications();
                        });
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to approve enrollment: ' + error.message,
                            confirmButtonColor: '#4361ee'
                        });
                    }
                }
            });
        }
        
        // Reject enrollment
        async function rejectEnrollment(enrollmentId) {
            Swal.fire({
                title: 'Reject Enrollment?',
                input: 'textarea',
                inputLabel: 'Reason for rejection (optional)',
                inputPlaceholder: 'Enter reason for rejection...',
                showCancelButton: true,
                confirmButtonColor: '#ef233c',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Reject'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Processing...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    try {
                        if (!window.firebaseDBInstance) {
                            throw new Error('Firebase DB not initialized');
                        }
                        
                        // Get enrollment data from Firebase
                        const enrollmentResult = await window.firebaseDBInstance.getAdmission(enrollmentId);
                        if (!enrollmentResult || !enrollmentResult.success || !enrollmentResult.data) {
                            throw new Error('Enrollment application not found');
                        }
                        
                        const enrollment = enrollmentResult.data;
                        
                        // Update enrollment status in Firebase
                        await window.firebaseDBInstance.updateAdmissionStatus(enrollmentId, 'Rejected');
                        
                        // Also update additional fields
                        await window.firebaseDb.collection('admissions').doc(enrollmentId).update({
                            rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            rejectedDate: new Date().toLocaleDateString(),
                            rejectionReason: result.value || '',
                            reviewed: true
                        });
                        
                        // Create notification
                        createNotification(
                            'Enrollment Rejected',
                            `Enrollment application for ${enrollment.firstName} ${enrollment.lastName} has been rejected.`,
                            'warning'
                        );
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Enrollment Rejected',
                            text: 'The enrollment application has been rejected.',
                            confirmButtonColor: '#4361ee'
                        }).then(() => {
                            viewEnrollmentApplications();
                        });
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to reject enrollment: ' + error.message,
                            confirmButtonColor: '#4361ee'
                        });
                    }
                }
            });
        }

        // Logout function
        function logout() {
            Swal.fire({
                title: 'Logout?',
                text: 'Are you sure you want to logout?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4361ee',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Logout',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading
                    Swal.fire({
                        title: 'Logging out...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Sign out from Firebase Auth
                    if (window.firebaseAuth) {
                        try {
                            await window.firebaseAuth.signOut();
                        } catch (error) {
                            console.error('Error signing out:', error);
                        }
                    }
                    
                    // Clear user session
                    localStorage.removeItem('prima_current_user');
                    
                    // Optional: Clear other session data if needed
                    // localStorage.clear(); // Uncomment if you want to clear all data
                    
                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Logged Out',
                            text: 'You have been successfully logged out',
                            confirmButtonColor: '#4361ee',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.href = 'admin-login.html';
                        });
                    }, 500);
                }
            });
        }

        // ========== AUTHENTICATION CHECK ==========
        function waitForFirestoreInstance(timeout = 8000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                const interval = setInterval(() => {
                    if (window.firebaseDb && window.firebaseDBInstance) {
                        clearInterval(interval);
                        resolve(true);
                        return;
                    }
                    
                    if (Date.now() - start > timeout) {
                        clearInterval(interval);
                        reject(new Error('Firestore not initialized'));
                    }
                }, 150);
            });
        }

        function waitForAuthState(timeout = 8000) {
            return new Promise((resolve, reject) => {
                if (!window.firebaseAuth) {
                    reject(new Error('Firebase Auth not initialized'));
                    return;
                }
                
                let unsubscribe = null;
                const timer = setTimeout(() => {
                    if (typeof unsubscribe === 'function') {
                        unsubscribe();
                    }
                    reject(new Error('Authentication timed out'));
                }, timeout);
                
                unsubscribe = window.firebaseAuth.onAuthStateChanged(
                    (user) => {
                        clearTimeout(timer);
                        if (typeof unsubscribe === 'function') {
                            unsubscribe();
                        }
                        resolve(user);
                    },
                    (error) => {
                        clearTimeout(timer);
                        if (typeof unsubscribe === 'function') {
                            unsubscribe();
                        }
                        reject(error);
                    }
                );
            });
        }

        async function checkAuthentication() {
            try {
                await waitForFirestoreInstance();
                const user = await waitForAuthState();
                
                if (!user) {
                    window.location.href = 'admin-login.html';
                    return false;
                }
                
                const userDoc = await window.firebaseDb.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    await window.firebaseAuth.signOut();
                    window.location.href = 'admin-login.html';
                    return false;
                }
                
                const userData = userDoc.data();
                
                if (userData.role !== 'admin') {
                    await window.firebaseAuth.signOut();
                    Swal.fire({
                        icon: 'error',
                        title: 'Access Denied',
                        text: 'You do not have admin privileges.',
                        confirmButtonColor: '#4361ee'
                    }).then(() => {
                        window.location.href = 'admin-login.html';
                    });
                    return false;
                }
                
                if (!localStorage.getItem('prima_current_user')) {
                    const userSessionData = {
                        id: user.uid,
                        email: user.email,
                        name: userData.name || userData.username || user.email,
                        role: userData.role,
                        lastLogin: user.metadata?.lastSignInTime || new Date().toISOString()
                    };
                    localStorage.setItem('prima_current_user', JSON.stringify(userSessionData));
                }
                
                return true;
                
            } catch (error) {
                console.error('Authentication check error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Authentication Error',
                    text: 'Unable to verify your credentials. Please log in again.',
                    confirmButtonColor: '#4361ee'
                }).then(() => {
                    window.location.href = 'admin-login.html';
                });
                return false;
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            document.body.classList.add('auth-checking');
            const isAuthenticated = await checkAuthentication();
            
            if (!isAuthenticated) {
                return;
            }
            
            document.body.classList.remove('auth-checking');
            initializeDashboard();
        });
        
        function initializeDashboard() {
            // Load and display user data if available
            const currentUser = localStorage.getItem('prima_current_user');
            if (currentUser) {
                try {
                    const userData = JSON.parse(currentUser);
                    updateUserDisplay(userData);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
            
            // Load account settings
            loadAccountSettings();
            
            // Load profile picture if exists
            const profilePic = localStorage.getItem('prima_profile_picture');
            if (profilePic) {
                document.getElementById('userProfileImage').src = profilePic;
            }
            
            // Initialize notifications system
            initializeNotifications();
            
            // Setup enrollment file uploads
            setupEnrollmentFileUploads();
            
            // Refresh data before initializing
            refreshData();
            initializeTables();
            initializeCharts();
            
            // Update dashboard stats
            updateDashboardStats();
        }

        // Update dashboard statistics
        async function updateDashboardStats() {
            refreshData();
            const totalStudents = students.length;
            const totalInstructors = instructors.length;
            const totalClasses = classes.length;
            const totalRevenue = payments
                .filter(p => p.status === 'Completed')
                .reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // Get pending enrollments from Firebase
            let pendingEnrollments = 0;
            if (window.firebaseDBInstance) {
                try {
                    const enrollments = await fetchEnrollmentsFromFirebase();
                    pendingEnrollments = enrollments.filter(e => e.status === 'Pending' || e.status === 'pending').length;
                } catch (error) {
                    console.error('Error fetching pending enrollments:', error);
                }
            }
            
            // Update stat cards if they exist
            const statCards = document.querySelectorAll('.stat-info h3');
            if (statCards.length >= 4) {
                statCards[0].textContent = totalStudents.toLocaleString();
                statCards[1].textContent = totalInstructors.toLocaleString();
                statCards[2].textContent = totalClasses.toLocaleString();
                statCards[3].textContent = '$' + totalRevenue.toLocaleString();
            }
            
            // Show notification badge for pending enrollments if any
            if (pendingEnrollments > 0) {
                // Check if notification badge already exists
                let pendingBadge = document.getElementById('pendingEnrollmentsBadge');
                if (!pendingBadge) {
                    // Add badge to enrollment menu item
                    const enrollmentMenuItem = document.querySelector('[data-page="enrollment"]');
                    if (enrollmentMenuItem) {
                        pendingBadge = document.createElement('span');
                        pendingBadge.id = 'pendingEnrollmentsBadge';
                        pendingBadge.style.cssText = 'background: #f72585; color: white; border-radius: 10px; padding: 2px 8px; font-size: 0.7rem; margin-left: 5px;';
                        enrollmentMenuItem.querySelector('a').appendChild(pendingBadge);
                    }
                }
                if (pendingBadge) {
                    pendingBadge.textContent = pendingEnrollments;
                    pendingBadge.style.display = 'inline-block';
                }
            } else {
                const pendingBadge = document.getElementById('pendingEnrollmentsBadge');
                if (pendingBadge) {
                    pendingBadge.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>